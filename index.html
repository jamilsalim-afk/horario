<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>IFRO - Campus Cacoal — Sistema de Horários</title>
<style>
  :root{
    --if-green:#1f7a4c; --if-red:#b71c1c; --bg:#f6f8fa; --card:#fff; --muted:#586069;
    font-family: "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:#0b0b0b}
  .app{display:flex;min-height:100vh}
  /* Sidebar */
  .sidebar{
    width:280px;background:linear-gradient(180deg,var(--if-green),#0f5e3f);color:#fff;padding:18px 14px;box-sizing:border-box;
    display:flex;flex-direction:column;gap:12px;
  }
  .logoRow{display:flex;gap:12px;align-items:center}
  .logo{width:48px;height:48px;border-radius:8px;background:#fff;color:var(--if-green);display:flex;align-items:center;justify-content:center;font-weight:800}
  .brand{font-weight:700;font-size:14px}
  .dept{background:rgba(255,255,255,0.06);padding:10px;border-radius:8px;font-size:12px}
  .nav{display:flex;flex-direction:column;gap:6px;margin-top:6px}
  .nav > a{color:#fff;text-decoration:none;padding:10px;border-radius:8px;display:flex;align-items:center;justify-content:space-between;font-weight:700}
  .nav > a:hover{background:rgba(255,255,255,0.06)}
  .submenu{background:rgba(255,255,255,0.03);padding:8px;border-radius:8px;margin-top:6px;display:none;flex-direction:column;gap:6px}
  .submenu button{background:transparent;border:none;color:#fff;text-align:left;padding:8px;border-radius:6px;cursor:pointer;font-weight:600}
  .submenu button:hover{background:rgba(255,255,255,0.06)}
  /* Main */
  .main{flex:1;display:flex;flex-direction:column}
  header.mainHeader{display:flex;align-items:center;gap:12px;background:var(--card);padding:14px;border-radius:0 0 10px 10px;box-shadow:0 6px 18px rgba(20,20,40,0.05)}
  .titleGroup{display:flex;flex-direction:column}
  .title{font-weight:800}
  .subtitle{font-size:13px;color:var(--muted)}
  .topbarActions{margin-left:auto;display:flex;gap:8px;align-items:center}
  .btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
  .btn.primary{background:var(--if-green);color:white}
  .btn.warn{background:var(--if-red);color:white}
  .container{padding:18px;flex:1;overflow:auto}
  .card{background:var(--card);padding:14px;border-radius:10px;box-shadow:0 6px 18px rgba(20,20,40,0.04);margin-bottom:14px}
  label{display:block;font-weight:700;margin-top:8px}
  input[type=text],input[type=email],input[type=number],select,textarea{width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;margin-top:6px;box-sizing:border-box}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{border:1px solid #eee;padding:8px;text-align:left;font-size:14px}
  .row{display:flex;gap:12px}
  .col{flex:1}
  .muted{color:var(--muted);font-size:13px}
  .small{width:140px}
  .list{max-height:260px;overflow:auto;border-radius:8px;padding:8px;border:1px solid #eee;margin-top:8px;background:#fafafa}
  .item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:6px;background:#fff;margin-bottom:6px}
  .hidden{display:none}
  .flex{display:flex;align-items:center;gap:8px}
  @media (max-width:900px){.sidebar{display:none}.row{flex-direction:column}}
  /* login modal */
  .modal{position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;z-index:9999}
  .modalCard{background:#fff;padding:20px;border-radius:12px;width:420px;box-shadow:0 10px 30px rgba(10,10,10,0.2)}
  .tag{display:inline-block;padding:4px 8px;border-radius:16px;background:var(--accent);color:var(--if-green);font-weight:700;margin-left:6px}
  .danger{color:var(--if-red)}
  .smallBtn{padding:6px 8px;border-radius:8px;border:1px solid #ddd;background:#fff;cursor:pointer}
</style>
</head>
<body>
<div id="app" class="app">
  <aside class="sidebar" aria-label="menu">
    <div class="logoRow">
      <div class="logo">IF</div>
      <div>
        <div class="brand">INSTITUTO FEDERAL DE RONDÔNIA<br/><span style="font-weight:600;font-size:12px">CAMPUS CACOAL</span></div>
      </div>
    </div>
    <div class="dept">DEPARTAMENTO DE APOIO AO ENSINO<br/>COORDENAÇÃO DE DESENVOLVIMENTO DE FERRAMENTAS PEDAGÓGICAS</div>

    <nav class="nav">
      <a href="#" id="nav-cadastro">1 — CADASTRO <span class="muted">▸</span></a>
      <div class="submenu" id="sub-cadastro">
        <button data-screen="cad-professores">Professores</button>
        <button data-screen="cad-horarios-define">Horários (Períodos)</button>
        <button data-screen="cad-turmas">Turmas</button>
        <button data-screen="cad-disciplinas">Disciplinas</button>
        <button data-screen="cad-dias-letivos">Dias Letivos</button>
      </div>

      <a href="#" id="nav-relatorio">2 — RELATÓRIO</a>
      <div class="submenu" id="sub-relatorio">
        <button data-screen="rel-individual">Relatório Individual</button>
        <button data-screen="rel-turma">Relatório de Turma</button>
        <button data-screen="rel-disciplina">Relatório de Disciplina</button>
        <button data-screen="rel-export">Exportar CSV (Semana)</button>
      </div>

      <a href="#" id="nav-horario-base">3 — HORÁRIO BASE</a>
      <a href="#" id="nav-horario-semanal">4 — HORÁRIO SEMANAL</a>
      <a href="#" id="nav-admin">Administração</a>
    </nav>

    <div style="margin-top:auto">
      <div class="muted">Paleta:</div>
      <div style="display:flex;gap:6px;margin-top:8px">
        <div style="background:var(--if-green);width:18px;height:18px;border-radius:3px"></div>
        <div style="background:var(--if-red);width:18px;height:18px;border-radius:3px"></div>
        <div style="background:#fff;border:1px solid #ddd;width:18px;height:18px;border-radius:3px"></div>
      </div>
      <div style="margin-top:10px" id="userInfo" class="muted"></div>
      <div style="margin-top:8px">
        <button class="smallBtn" id="btn-logout" style="display:none">Sair</button>
      </div>
    </div>

  </aside>

  <main class="main">
    <header class="mainHeader">
      <div class="titleGroup">
        <div class="title">Gerador de Horários — IFRO Campus Cacoal <span class="tag">PROTÓTIPO</span></div>
        <div class="subtitle">Cadastros, geração, semanas e relatórios</div>
      </div>
      <div class="topbarActions">
        <button class="btn primary" id="btn-generate">Gerar Horário Base</button>
        <button class="btn" id="btn-create-weeks">Criar Semanas</button>
        <button class="btn" id="btn-print">Imprimir / PDF</button>
      </div>
    </header>

    <div class="container" id="container">

      <!-- Screen: Dashboard -->
      <div id="screen-dashboard" class="card screen">
        <h2>Visão Geral</h2>
        <p class="muted">Use o menu à esquerda para navegar. Faça login para habilitar edição.</p>
        <div style="display:flex;gap:12px;margin-top:12px;flex-wrap:wrap">
          <div style="background:#f1fbf4;padding:12px;border-radius:8px;border:1px solid #e1efe6;width:220px">
            <strong>Professores</strong><div id="stat-prof-count" class="muted">0</div>
          </div>
          <div style="background:#fff4f4;padding:12px;border-radius:8px;border:1px solid #f3dede;width:220px">
            <strong>Disciplinas</strong><div id="stat-subj-count" class="muted">0</div>
          </div>
          <div style="background:#fff;padding:12px;border-radius:8px;border:1px solid #eee;width:220px">
            <strong>Turmas</strong><div id="stat-class-count" class="muted">0</div>
          </div>
        </div>
      </div>

      <!-- Screen: Cadastro Professores -->
      <div id="screen-cad-professores" class="card screen hidden">
        <h2>Cadastro de Professores</h2>
        <form id="form-professor">
          <div class="row">
            <div class="col">
              <label>Nome completo *</label>
              <input type="text" id="prof-nome" required>
            </div>
            <div class="col">
              <label>Siape / CPF</label>
              <input type="text" id="prof-siape">
            </div>
          </div>

          <div class="row">
            <div class="col">
              <label>Situação</label>
              <select id="prof-situacao">
                <option value="DE">DE</option>
                <option value="40">40</option>
                <option value="20">20</option>
                <option value="Substituto">Substituto</option>
              </select>
            </div>
            <div class="col">
              <label>Sigla / Apelido</label>
              <input type="text" id="prof-sigla" placeholder="ex: MAT">
            </div>
          </div>

          <h3 style="margin-top:12px">Restrições</h3>
          <div style="display:flex;gap:12px;flex-wrap:wrap">
            <div style="min-width:220px">
              <label>PRD (ex.: PRD dia inteiro ou turnos)</label>
              <select id="prof-prd">
                <option value="">Nenhuma</option>
                <option value="dia">Dia inteiro</option>
                <option value="manha">Manhã</option>
                <option value="tarde">Tarde</option>
                <option value="noite">Noite</option>
              </select>
            </div>
            <div style="min-width:220px">
              <label>PGD</label>
              <select id="prof-pgd">
                <option value="">Nenhuma</option>
                <option value="dia">Dia inteiro</option>
                <option value="manha">Manhã</option>
                <option value="tarde">Tarde</option>
                <option value="noite">Noite</option>
              </select>
            </div>
          </div>

          <div style="margin-top:8px;display:flex;gap:12px;flex-wrap:wrap">
            <div style="min-width:220px">
              <label>Descanso 11h entre nocturna → manhã?</label>
              <select id="prof-descanso">
                <option value="1">Aplicar</option>
                <option value="0">Não aplicar</option>
              </select>
            </div>
            <div style="min-width:220px">
              <label>Não pode dar a 1ª aula da manhã?</label>
              <select id="prof-no-first-m">
                <option value="0">Não</option>
                <option value="1">Sim</option>
              </select>
            </div>
            <div style="min-width:220px">
              <label>Não pode dar as 2 primeiras da manhã?</label>
              <select id="prof-no-first2-m">
                <option value="0">Não</option>
                <option value="1">Sim</option>
              </select>
            </div>
            <div style="min-width:220px">
              <label>Não pode dar a última da manhã?</label>
              <select id="prof-no-last-m">
                <option value="0">Não</option>
                <option value="1">Sim</option>
              </select>
            </div>
          </div>

          <div style="margin-top:8px;display:flex;gap:12px;flex-wrap:wrap">
            <div style="min-width:220px">
              <label>Não pode dar 1ª da tarde?</label>
              <select id="prof-no-first-t">
                <option value="0">Não</option><option value="1">Sim</option>
              </select>
            </div>
            <div style="min-width:220px">
              <label>Não pode dar as 2 últimas da tarde?</label>
              <select id="prof-no-last2-t">
                <option value="0">Não</option><option value="1">Sim</option>
              </select>
            </div>
          </div>

          <div style="margin-top:12px;display:flex;gap:8px">
            <button class="btn primary" id="btn-save-prof">Salvar professor</button>
            <button type="button" class="btn" id="btn-clear-prof">Limpar</button>
          </div>
        </form>

        <div style="margin-top:14px">
          <h3>Lista de Professores</h3>
          <div id="list-professores" class="list"></div>
        </div>
      </div>

      <!-- Screen: Horários (definir períodos por turno) -->
      <div id="screen-cad-horarios-define" class="card screen hidden">
        <h2>Horários de Aulas (definição de períodos)</h2>
        <p class="muted">Defina os períodos por turno. Use o padrão já fornecido ou personalize.</p>

        <label>Manhã — períodos (separe por | )</label>
        <input type="text" id="periods-manha" value="07:30-08:20|08:20-09:10|...INTERVALO...|09:30-10:20|10:20-11:10|11:10-12:00">

        <label>Tarde</label>
        <input type="text" id="periods-tarde" value="13:50-14:40|14:40-15:30|...INTERVALO...|15:50-16:40|16:40-17:30|17:30-18:20">

        <label>Noite</label>
        <input type="text" id="periods-noite" value="19:00-19:50|19:50-20:40|...INTERVALO...|20:50-21:40|21:40-22:30">

        <div style="margin-top:8px">
          <button class="btn primary" id="btn-save-periods">Salvar horários</button>
        </div>
      </div>

      <!-- Screen: Turmas -->
      <div id="screen-cad-turmas" class="card screen hidden">
        <h2>Cadastro de Turmas</h2>
        <form id="form-turma">
          <div class="row">
            <div class="col">
              <label>Nome da turma *</label>
              <input type="text" id="turma-nome" required>
            </div>
            <div class="col">
              <label>Regime</label>
              <select id="turma-regime"><option>Integrado</option><option>Superior</option></select>
            </div>
            <div class="col">
              <label>Turno</label>
              <select id="turma-turno"><option>Manhã</option><option>Tarde</option><option>Noite</option></select>
            </div>
          </div>
          <div style="margin-top:8px">
            <button class="btn primary" id="btn-save-turma">Salvar turma</button>
            <button class="btn" id="btn-clear-turma" type="button">Limpar</button>
          </div>
        </form>

        <div style="margin-top:12px">
          <h3>Lista de Turmas</h3>
          <div id="list-turmas" class="list"></div>
        </div>
      </div>

      <!-- Screen: Disciplinas -->
      <div id="screen-cad-disciplinas" class="card screen hidden">
        <h2>Cadastro de Disciplinas</h2>
        <form id="form-disciplina">
          <div class="row">
            <div class="col">
              <label>Nome da disciplina *</label>
              <input type="text" id="disc-nome" required>
            </div>
            <div class="col">
              <label>CH anual/semestre (horas)</label>
              <input type="number" id="disc-ch" min="1" value="60" required>
            </div>
            <div class="col">
              <label>Turma *</label>
              <select id="disc-turma"></select>
            </div>
          </div>

          <div class="row">
            <div class="col">
              <label>Professor (opcional)</label>
              <select id="disc-professor"></select>
            </div>
            <div class="col">
              <label>Aulas semanais (ex: 4)</label>
              <input type="number" id="disc-aulas-semana" min="1" value="4" required>
            </div>
          </div>

          <div style="margin-top:8px">
            <button class="btn primary" id="btn-save-disc">Salvar disciplina</button>
            <button class="btn" id="btn-clear-disc" type="button">Limpar</button>
          </div>
        </form>

        <div style="margin-top:12px">
          <h3>Lista de Disciplinas</h3>
          <div id="list-disciplinas" class="list"></div>
        </div>
      </div>

      <!-- Screen: Dias Letivos -->
      <div id="screen-cad-dias-letivos" class="card screen hidden">
        <h2>Dias Letivos</h2>
        <p class="muted">Marque dias letivos, feriados, recuperação e exame por regime (Integrado / Superior).</p>
        <div style="display:flex;gap:12px;flex-wrap:wrap">
          <div style="flex:1">
            <label>Regime</label>
            <select id="cal-regime"><option>Integrado</option><option>Superior</option></select>
            <label>Data</label>
            <input type="date" id="cal-date">
            <label>Tipo</label>
            <select id="cal-type"><option value="letivo">Letivo</option><option value="feriado">Feriado</option><option value="recuperacao">Recuperação</option><option value="exame">Exame</option></select>
            <div style="margin-top:8px">
              <button class="btn primary" id="btn-save-cal">Salvar</button>
              <button class="btn" id="btn-clear-cal" type="button">Limpar</button>
            </div>
          </div>
          <div style="flex:2">
            <h3>Calendário</h3>
            <div id="list-calendar" class="list"></div>
          </div>
        </div>
      </div>

      <!-- Screen: Relatórios -->
      <div id="screen-rel-individual" class="card screen hidden">
        <h2>Relatório Individual (Professor)</h2>
        <label>Professor</label>
        <select id="rel-prof-list"></select>
        <label>Período (início)</label>
        <input type="date" id="rel-start">
        <label>Período (fim)</label>
        <input type="date" id="rel-end">
        <div style="margin-top:8px">
          <button class="btn primary" id="btn-gen-rel-ind">Gerar Relatório</button>
          <button class="btn" id="btn-export-rel-csv">Exportar CSV</button>
        </div>
        <div id="report-area" style="margin-top:12px"></div>
      </div>

      <div id="screen-rel-turma" class="card screen hidden">
        <h2>Relatório de Turma</h2>
        <label>Turma</label>
        <select id="rel-turma-list"></select>
        <label>Período início</label><input type="date" id="rel-t-start">
        <label>Período fim</label><input type="date" id="rel-t-end">
        <div style="margin-top:8px">
          <button class="btn primary" id="btn-gen-rel-turma">Gerar Relatório</button>
        </div>
        <div id="report-area-turma" style="margin-top:12px"></div>
      </div>

      <div id="screen-rel-disciplina" class="card screen hidden">
        <h2>Relatório de Disciplina</h2>
        <label>Turma</label>
        <select id="rel-disc-turma"></select>
        <label>Disciplina</label>
        <select id="rel-disc-list"></select>
        <label>Período início</label><input type="date" id="rel-d-start">
        <label>Período fim</label><input type="date" id="rel-d-end">
        <div style="margin-top:8px">
          <button class="btn primary" id="btn-gen-rel-disc">Gerar Relatório</button>
        </div>
        <div id="report-area-disc" style="margin-top:12px"></div>
      </div>

      <!-- Screen: Horário Base -->
      <div id="screen-horario-base" class="card screen hidden">
        <h2>Horário Base</h2>
        <p class="muted">Gere horário base por turma e visualize. O gerador respeita restrições de professor (posição, descanso 11h, PRD/PGD).</p>
        <div style="display:flex;gap:12px;align-items:center">
          <label style="margin:0">Selecione Turma</label>
          <select id="hb-turma"></select>
          <button class="btn primary" id="hb-gen-one">Gerar para Turma</button>
          <button class="btn" id="hb-gen-all">Gerar para Todas</button>
        </div>
        <div id="hb-area" style="margin-top:12px"></div>
      </div>

      <!-- Screen: Horário Semanal -->
      <div id="screen-horario-semanal" class="card screen hidden">
        <h2>Horário Semanal</h2>
        <p class="muted">Crie semanas a partir do horário base, edite manualmente e salve instâncias semanais.</p>
        <div style="display:flex;gap:12px;align-items:center">
          <label>Início da semana</label>
          <input type="date" id="ws-start">
          <label>Turma</label>
          <select id="ws-turma"></select>
          <button class="btn primary" id="ws-create">Criar Semana</button>
        </div>
        <div id="ws-area" style="margin-top:12px"></div>
      </div>

      <!-- Screen: Admin (usuários) -->
      <div id="screen-admin" class="card screen hidden">
        <h2>Administração</h2>
        <p class="muted">Gerenciar usuários (apenas admins) e configurações.</p>
        <div style="display:flex;gap:12px">
          <div style="flex:1">
            <label>Usuário</label><input type="text" id="admin-user">
            <label>Senha</label><input type="text" id="admin-pass">
            <label>Role</label>
            <select id="admin-role"><option value="admin">admin</option><option value="user">user</option></select>
            <div style="margin-top:8px"><button class="btn primary" id="btn-create-user">Criar usuário</button></div>
          </div>
          <div style="flex:2">
            <h3>Lista de Usuários</h3>
            <div id="list-users" class="list"></div>
          </div>
        </div>
      </div>

    </div>
  </main>
</div>

<!-- Login modal -->
<div id="modal-login" class="modal hidden" aria-hidden="true">
  <div class="modalCard">
    <h3>Entrar no Sistema</h3>
    <p class="muted">Use as credenciais de protótipo: <strong>admin/admin</strong> (admin) ou <strong>user/user</strong> (usuário).</p>
    <label>Usuário</label><input id="login-username" type="text" value="">
    <label>Senha</label><input id="login-password" type="password" value="">
    <div style="margin-top:10px;display:flex;gap:8px;justify-content:flex-end">
      <button class="btn" id="login-cancel">Cancelar</button>
      <button class="btn primary" id="login-submit">Entrar</button>
    </div>
    <div style="margin-top:8px" id="login-msg" class="muted"></div>
  </div>
</div>

<script>
/* -------------------------
   Storage keys & state
   ------------------------- */
const KEY = 'ifro_timetable_v1';
const KEY_USERS = 'ifro_users_v1';
let state = {
  professors: [], // {id,nome,siape,situacao,sigla,restrictions:{...}}
  classes: [], // {id,nome,regime,turno}
  subjects: [], // {id,nome,ch,classId,professorId,aulasSemana}
  periods: { manha: [], tarde: [], noite: [] }, // arrays of strings
  calendars: [], // {regime,date,type}
  baseSchedules: {}, // classId -> grid [dayIndex][periodIndex] = {subjectId,professorId}
  weeklySchedules: [], // {id,classId,weekStart:YYYY-MM-DD,schedule:grid}
  users: [], // {username, password (plain in prototipo), role}
  currentUser: null
};

/* --------------- Utilities -------------- */
function uid(prefix='id'){return prefix+'_'+Math.random().toString(36).slice(2,9)}
function saveAll(){ localStorage.setItem(KEY, JSON.stringify(state)); localStorage.setItem(KEY_USERS, JSON.stringify(state.users)); updateStats(); }
function loadAll(){
  const raw = localStorage.getItem(KEY);
  const rawUsers = localStorage.getItem(KEY_USERS);
  if(raw) try{ Object.assign(state, JSON.parse(raw)) }catch(e){ console.warn(e) }
  if(rawUsers) try{ state.users = JSON.parse(rawUsers) }catch(e){ console.warn(e) }
  // ensure defaults
  if(!state.periods) state.periods = {manha: [], tarde: [], noite: []};
  if(!state.users || state.users.length===0){
    // create default users (admin/user) if none
    state.users = [{username:'admin',password:'admin',role:'admin'},{username:'user',password:'user',role:'user'}];
  }
}
function findById(arr,id){ return arr.find(x=>x.id===id) }
function fmtDate(d){ return (new Date(d)).toISOString().slice(0,10) }

/* --------------- Initialization -------------- */
loadAll();
renderUI();
bindNav();
updateStats();
showLoginIfNeeded();

/* --------------- UI + Binding -------------- */
function bindNav(){
  document.getElementById('nav-cadastro').addEventListener('click',()=>toggleSub('sub-cadastro'));
  document.getElementById('nav-relatorio').addEventListener('click',()=>toggleSub('sub-relatorio'));
  // submenu buttons
  document.querySelectorAll('#sub-cadastro button').forEach(b=>b.addEventListener('click', e=>openScreen(e.target.dataset.screen)));
  document.querySelectorAll('#sub-relatorio button').forEach(b=>b.addEventListener('click', e=>openScreen(e.target.dataset.screen)));
  // other navs
  document.getElementById('nav-horario-base').addEventListener('click',()=>openScreen('horario-base'));
  document.getElementById('nav-horario-semanal').addEventListener('click',()=>openScreen('horario-semanal'));
  document.getElementById('nav-admin').addEventListener('click',()=>openScreen('admin'));

  // login modal binding
  document.getElementById('login-submit').addEventListener('click', loginSubmit);
  document.getElementById('login-cancel').addEventListener('click', ()=>hideLogin());
  document.getElementById('btn-logout').addEventListener('click', logout);

  // form actions
  document.getElementById('btn-save-prof').addEventListener('click', saveProfessor);
  document.getElementById('btn-clear-prof').addEventListener('click', clearFormProfessor);

  document.getElementById('btn-save-periods').addEventListener('click', savePeriods);

  document.getElementById('btn-save-turma').addEventListener('click', saveTurma);
  document.getElementById('btn-clear-turma').addEventListener('click', ()=>{ document.getElementById('form-turma').reset(); });

  document.getElementById('btn-save-disc').addEventListener('click', saveDisciplina);
  document.getElementById('btn-clear-disc').addEventListener('click', ()=>{ document.getElementById('form-disciplina').reset(); });

  document.getElementById('btn-save-cal').addEventListener('click', saveCalendar);
  document.getElementById('btn-clear-cal').addEventListener('click', ()=>{ document.getElementById('cal-date').value=''; });

  document.getElementById('btn-create-user').addEventListener('click', createUser);
  document.getElementById('btn-generate').addEventListener('click', ()=>openScreen('horario-base'));
  document.getElementById('btn-print').addEventListener('click', ()=>print());

  // Relatórios
  document.getElementById('btn-gen-rel-ind').addEventListener('click', genRelIndividual);
  document.getElementById('btn-export-rel-csv').addEventListener('click', exportRelCSV);
  document.getElementById('btn-gen-rel-turma').addEventListener('click', genRelTurma);
  document.getElementById('btn-gen-rel-disc').addEventListener('click', genRelDisciplina);

  // Horario base
  document.getElementById('hb-gen-one').addEventListener('click', ()=>generateHorarioForSelected(true));
  document.getElementById('hb-gen-all').addEventListener('click', ()=>generateHorarioForSelected(false));

  // Weekly schedules
  document.getElementById('ws-create').addEventListener('click', createWeekInstance);
  document.getElementById('btn-create-weeks').addEventListener('click', ()=>{ alert('Criar semanas automáticas: função disponível via Horário Base / Horário Semanal.'); });

  // initial options populate
  populateProfList();
  populateClassList();
  populateDiscSelects();
  populateUsersList();
}

/* ----------------- Navigation & Screens ----------------- */
function toggleSub(id){
  const el = document.getElementById(id);
  el.style.display = el.style.display==='flex' ? 'none' : 'flex';
}
function openScreen(key){
  // hide all screens
  document.querySelectorAll('.screen').forEach(s=>s.classList.add('hidden'));
  // map keys
  const map = {
    'cad-professores':'screen-cad-professores',
    'cad-horarios-define':'screen-cad-horarios-define',
    'cad-turmas':'screen-cad-turmas',
    'cad-disciplinas':'screen-cad-disciplinas',
    'cad-dias-letivos':'screen-cad-dias-letivos',
    'rel-individual':'screen-rel-individual',
    'rel-turma':'screen-rel-turma',
    'rel-disciplina':'screen-rel-disciplina',
    'rel-export':'screen-rel-individual',
    'horario-base':'screen-horario-base',
    'horario-semanal':'screen-horario-semanal',
    'admin':'screen-admin'
  };
  const id = map[key] || 'screen-dashboard';
  document.getElementById(id).classList.remove('hidden');
  // extra population
  if(id==='screen-cad-disciplinas') populateDiscSelects();
  if(id==='screen-cad-professores') renderProfessorList();
  if(id==='screen-cad-turmas') renderTurmas();
  if(id==='screen-cad-dias-letivos') renderCalendars();
  if(id==='screen-rel-individual') populateRelProf();
  if(id==='screen-horario-base') populateHBSelects();
  if(id==='screen-horario-semanal') populateWSSelects();
  if(id==='screen-admin') populateUsersList();
  window.scrollTo(0,0);
}

/* ----------------- Professors CRUD ----------------- */
function clearFormProfessor(){ document.getElementById('form-professor').reset(); }
function saveProfessor(e){
  e?.preventDefault();
  if(!isLoggedAdmin()){ alert('Ação restrita a administradores. Faça login como admin.'); showLogin(); return; }
  const nome = document.getElementById('prof-nome').value.trim();
  if(!nome){ alert('Nome é obrigatório'); return; }
  const prof = {
    id: uid('p'), nome,
    siape: document.getElementById('prof-siape').value.trim(),
    situacao: document.getElementById('prof-situacao').value,
    sigla: document.getElementById('prof-sigla').value.trim(),
    restrictions: {
      prd: document.getElementById('prof-prd').value || null,
      pgd: document.getElementById('prof-pgd').value || null,
      descanso11: document.getElementById('prof-descanso').value==='1',
      noFirstM: document.getElementById('prof-no-first-m').value==='1',
      noFirst2M: document.getElementById('prof-no-first2-m').value==='1',
      noLastM: document.getElementById('prof-no-last-m').value==='1',
      noFirstT: document.getElementById('prof-no-first-t').value==='1',
      noLast2T: document.getElementById('prof-no-last2-t').value==='1'
    }
  };
  state.professors.push(prof); saveAll(); renderProfessorList(); populateProfList(); populateDiscSelects();
  document.getElementById('form-professor').reset();
}
function renderProfessorList(){
  const el = document.getElementById('list-professores'); el.innerHTML='';
  state.professors.forEach(p=>{
    const div = document.createElement('div'); div.className='item';
    const left = document.createElement('div'); left.innerHTML = `<strong>${p.nome}</strong><div class="muted">${p.situacao} • ${p.siape || ''}</div>`;
    const right = document.createElement('div');
    const edit = document.createElement('button'); edit.className='smallBtn'; edit.textContent='Editar'; edit.onclick = ()=>editProfessor(p.id);
    const del = document.createElement('button'); del.className='smallBtn'; del.textContent='Remover'; del.onclick = ()=>{ if(confirm('Remover professor?')){ state.professors = state.professors.filter(x=>x.id!==p.id); // unlink from disciplines
      state.subjects.forEach(s=>{ if(s.professorId===p.id) s.professorId=null }); saveAll(); renderProfessorList(); populateProfList(); } };
    right.appendChild(edit); right.appendChild(del);
    div.appendChild(left); div.appendChild(right);
    el.appendChild(div);
  });
}
function editProfessor(id){
  if(!isLoggedAdmin()){ alert('Somente admin pode editar'); showLogin(); return; }
  const p = findById(state.professors,id); if(!p) return;
  openScreen('cad-professores');
  document.getElementById('prof-nome').value = p.nome;
  document.getElementById('prof-siape').value = p.siape||'';
  document.getElementById('prof-situacao').value = p.situacao||'DE';
  document.getElementById('prof-sigla').value = p.sigla||'';
  document.getElementById('prof-prd').value = p.restrictions?.prd || '';
  document.getElementById('prof-pgd').value = p.restrictions?.pgd || '';
  document.getElementById('prof-descanso').value = p.restrictions?.descanso11 ? '1':'0';
  document.getElementById('prof-no-first-m').value = p.restrictions?.noFirstM ? '1':'0';
  document.getElementById('prof-no-first2-m').value = p.restrictions?.noFirst2M ? '1':'0';
  document.getElementById('prof-no-last-m').value = p.restrictions?.noLastM ? '1':'0';
  document.getElementById('prof-no-first-t').value = p.restrictions?.noFirstT ? '1':'0';
  document.getElementById('prof-no-last2-t').value = p.restrictions?.noLast2T ? '1':'0';
  // when saving after edit replace item instead of adding - implement a simple pattern: remove old and add new with same id
  // override save button to act as update
  const saveBtn = document.getElementById('btn-save-prof');
  saveBtn.textContent = 'Atualizar professor';
  saveBtn.onclick = function updateHandler(evt){
    evt?.preventDefault();
    const nome2 = document.getElementById('prof-nome').value.trim(); if(!nome2){ alert('Nome é obrigatório'); return; }
    p.nome = nome2; p.siape = document.getElementById('prof-siape').value.trim();
    p.situacao = document.getElementById('prof-situacao').value;
    p.sigla = document.getElementById('prof-sigla').value.trim();
    p.restrictions = {
      prd: document.getElementById('prof-prd').value||null,
      pgd: document.getElementById('prof-pgd').value||null,
      descanso11: document.getElementById('prof-descanso').value==='1',
      noFirstM: document.getElementById('prof-no-first-m').value==='1',
      noFirst2M: document.getElementById('prof-no-first2-m').value==='1',
      noLastM: document.getElementById('prof-no-last-m').value==='1',
      noFirstT: document.getElementById('prof-no-first-t').value==='1',
      noLast2T: document.getElementById('prof-no-last2-t').value==='1'
    };
    saveAll(); renderProfessorList(); populateProfList(); populateDiscSelects();
    saveBtn.textContent = 'Salvar professor';
    saveBtn.onclick = saveProfessor;
    document.getElementById('form-professor').reset();
  };
}

/* ----------------- Periods Save ----------------- */
function savePeriods(){
  if(!isLoggedAdmin()){ alert('Ação restrita a administradores. Faça login como admin.'); showLogin(); return; }
  const manha = document.getElementById('periods-manha').value.split('|').map(x=>x.trim());
  const tarde = document.getElementById('periods-tarde').value.split('|').map(x=>x.trim());
  const noite = document.getElementById('periods-noite').value.split('|').map(x=>x.trim());
  state.periods.manha = manha; state.periods.tarde = tarde; state.periods.noite = noite;
  saveAll(); alert('Períodos salvos');
}

/* ----------------- Turmas ----------------- */
function saveTurma(e){
  e?.preventDefault();
  if(!isLoggedAdmin()){ alert('Somente admin.'); showLogin(); return; }
  const nome=document.getElementById('turma-nome').value.trim(); if(!nome){ alert('Nome obrigatório'); return; }
  const turma={id:uid('c'),nome,regime:document.getElementById('turma-regime').value,turno:document.getElementById('turma-turno').value};
  state.classes.push(turma); saveAll(); renderTurmas(); populateClassList(); populateDiscSelects();
  document.getElementById('form-turma').reset();
}
function renderTurmas(){
  const el=document.getElementById('list-turmas'); el.innerHTML='';
  state.classes.forEach(t=>{
    const div=document.createElement('div'); div.className='item';
    const left=document.createElement('div'); left.innerHTML=`<strong>${t.nome}</strong><div class="muted">${t.regime} • ${t.turno}</div>`;
    const right=document.createElement('div');
    const edit=document.createElement('button'); edit.className='smallBtn'; edit.textContent='Editar'; edit.onclick=()=>editTurma(t.id);
    const del=document.createElement('button'); del.className='smallBtn'; del.textContent='Remover'; del.onclick=()=>{ if(confirm('Remover turma?')){ state.classes=state.classes.filter(x=>x.id!==t.id); state.subjects=state.subjects.filter(s=>s.classId!==t.id); delete state.baseSchedules[t.id]; saveAll(); renderTurmas(); populateClassList(); } };
    right.appendChild(edit); right.appendChild(del);
    div.appendChild(left); div.appendChild(right); el.appendChild(div);
  });
}
function editTurma(id){
  if(!isLoggedAdmin()){ alert('Somente admin'); showLogin(); return; }
  const t=findById(state.classes,id); if(!t) return;
  openScreen('cad-turmas');
  document.getElementById('turma-nome').value=t.nome;
  document.getElementById('turma-regime').value=t.regime;
  document.getElementById('turma-turno').value=t.turno;
  const saveBtn=document.getElementById('btn-save-turma');
  saveBtn.textContent='Atualizar turma';
  saveBtn.onclick=function update(e){
    e?.preventDefault();
    t.nome=document.getElementById('turma-nome').value.trim();
    t.regime=document.getElementById('turma-regime').value;
    t.turno=document.getElementById('turma-turno').value;
    saveAll(); renderTurmas(); populateClassList();
    saveBtn.textContent='Salvar turma'; saveBtn.onclick=saveTurma; document.getElementById('form-turma').reset();
  };
}

/* ----------------- Disciplinas ----------------- */
function populateDiscSelects(){
  const s1=document.getElementById('disc-turma'); s1.innerHTML='';
  state.classes.forEach(c=>{ const o=document.createElement('option'); o.value=c.id; o.textContent=c.nome; s1.appendChild(o); });
  const s2=document.getElementById('disc-professor'); s2.innerHTML='<option value="">-- escolher --</option>';
  state.professors.forEach(p=>{ const o=document.createElement('option'); o.value=p.id; o.textContent=p.nome + (p.sigla?` (${p.sigla})`:'' ); s2.appendChild(o); });
  // report selects
  const rtd=document.getElementById('rel-turma-list'); rtd.innerHTML=''; state.classes.forEach(c=>{ const o=document.createElement('option'); o.value=c.id; o.textContent=c.nome; rtd.appendChild(o); });
  const rtt=document.getElementById('rel-disc-turma'); rtt.innerHTML=''; state.classes.forEach(c=>{ const o=document.createElement('option'); o.value=c.id; o.textContent=c.nome; rtt.appendChild(o); });
  const wsT=document.getElementById('ws-turma'); wsT.innerHTML=''; state.classes.forEach(c=>{ const o=document.createElement('option'); o.value=c.id; o.textContent=c.nome; wsT.appendChild(o); });
  const hbT=document.getElementById('hb-turma'); hbT.innerHTML=''; state.classes.forEach(c=>{ const o=document.createElement('option'); o.value=c.id; o.textContent=c.nome; hbT.appendChild(o); });
  const wsT2=document.getElementById('ws-turma'); wsT2.innerHTML=''; state.classes.forEach(c=>{ const o=document.createElement('option'); o.value=c.id; o.textContent=c.nome; wsT2.appendChild(o); });
  // discipline report list update
  const relDiscList=document.getElementById('rel-disc-list'); relDiscList.innerHTML='';
  state.subjects.filter(s=>s.classId=== (rtt.value||'') ).forEach(d=>{ const o=document.createElement('option'); o.value=d.id; o.textContent=d.nome; relDiscList.appendChild(o);});
}
function saveDisciplina(e){
  e?.preventDefault();
  if(!isLoggedAdmin()){ alert('Somente admin'); showLogin(); return; }
  const nome=document.getElementById('disc-nome').value.trim(); if(!nome){ alert('Nome obrig'); return; }
  const ch= parseInt(document.getElementById('disc-ch').value)||0;
  const classId=document.getElementById('disc-turma').value;
  const profId=document.getElementById('disc-professor').value || null;
  const aulas = parseInt(document.getElementById('disc-aulas-semana').value) || 1;
  const disc = {id: uid('s'), nome, ch, classId, professorId: profId, aulasSemana: aulas};
  state.subjects.push(disc); saveAll(); renderDisciplinas(); populateDiscSelects(); document.getElementById('form-disciplina').reset();
}
function renderDisciplinas(){
  const el = document.getElementById('list-disciplinas'); el.innerHTML='';
  state.subjects.forEach(s=>{
    const div=document.createElement('div'); div.className='item';
    const profName = s.professorId ? (findById(state.professors,s.professorId)?.nome || '(?)') : '(sem)';
    const left=document.createElement('div'); left.innerHTML=`<strong>${s.nome}</strong><div class="muted">${s.ch}h • ${profName}</div>`;
    const right=document.createElement('div');
    const edit=document.createElement('button'); edit.className='smallBtn'; edit.textContent='Editar'; edit.onclick=()=>editDisciplina(s.id);
    const del=document.createElement('button'); del.className='smallBtn'; del.textContent='Remover'; del.onclick=()=>{ if(confirm('Remover disciplina?')){ state.subjects=state.subjects.filter(x=>x.id!==s.id); saveAll(); renderDisciplinas(); populateDiscSelects(); } };
    right.appendChild(edit); right.appendChild(del);
    div.appendChild(left); div.appendChild(right); el.appendChild(div);
  });
}
function editDisciplina(id){
  if(!isLoggedAdmin()){ alert('Somente admin'); showLogin(); return; }
  const s = findById(state.subjects,id); if(!s) return;
  openScreen('cad-disciplinas');
  document.getElementById('disc-nome').value = s.nome;
  document.getElementById('disc-ch').value = s.ch;
  document.getElementById('disc-turma').value = s.classId;
  document.getElementById('disc-professor').value = s.professorId || '';
  document.getElementById('disc-aulas-semana').value = s.aulasSemana;
  const saveBtn = document.getElementById('btn-save-disc');
  saveBtn.textContent = 'Atualizar';
  saveBtn.onclick = function update(e){
    e?.preventDefault();
    s.nome = document.getElementById('disc-nome').value.trim();
    s.ch = parseInt(document.getElementById('disc-ch').value)||0;
    s.classId = document.getElementById('disc-turma').value;
    s.professorId = document.getElementById('disc-professor').value || null;
    s.aulasSemana = parseInt(document.getElementById('disc-aulas-semana').value)||1;
    saveAll(); renderDisciplinas(); populateDiscSelects();
    saveBtn.textContent = 'Salvar disciplina'; saveBtn.onclick = saveDisciplina; document.getElementById('form-disciplina').reset();
  };
}

/* ----------------- Calendars ----------------- */
function saveCalendar(e){
  e?.preventDefault();
  if(!isLoggedAdmin()){ alert('Somente admin'); showLogin(); return; }
  const regime = document.getElementById('cal-regime').value;
  const date = document.getElementById('cal-date').value;
  const type = document.getElementById('cal-type').value;
  if(!date){ alert('Informe data'); return; }
  state.calendars.push({id: uid('cal'), regime, date, type});
  saveAll(); renderCalendars(); document.getElementById('cal-date').value='';
}
function renderCalendars(){
  const el = document.getElementById('list-calendar'); el.innerHTML='';
  state.calendars.slice().sort((a,b)=>a.date.localeCompare(b.date)).forEach(c=>{
    const div=document.createElement('div'); div.className='item';
    const left=document.createElement('div'); left.innerHTML=`<strong>${c.date}</strong><div class="muted">${c.regime} • ${c.type}</div>`;
    const right=document.createElement('div');
    const del=document.createElement('button'); del.className='smallBtn'; del.textContent='Remover'; del.onclick=()=>{ if(confirm('Remover?')){ state.calendars=state.calendars.filter(x=>x.id!==c.id); saveAll(); renderCalendars(); } };
    right.appendChild(del); div.appendChild(left); div.appendChild(right); el.appendChild(div);
  });
}

/* ----------------- Reports ----------------- */
function populateRelProf(){
  const el = document.getElementById('rel-prof-list'); el.innerHTML='';
  const o=document.createElement('option'); o.value=''; o.textContent='-- selecione --';
  el.appendChild(o);
  state.professors.forEach(p=>{ const opt=document.createElement('option'); opt.value=p.id; opt.textContent=p.nome; el.appendChild(opt); });
  document.getElementById('rel-start').value=''; document.getElementById('rel-end').value='';
}
function genRelIndividual(){
  const profId = document.getElementById('rel-prof-list').value; if(!profId){ alert('Selecione professor'); return; }
  const start = document.getElementById('rel-start').value || '1900-01-01';
  const end = document.getElementById('rel-end').value || '2100-01-01';
  // gather from weeklySchedules within date range
  const records = [];
  state.weeklySchedules.forEach(ws=>{
    if(ws.classId==null) return;
    const wstart = ws.weekStart;
    if(wstart < start || wstart > end) return;
    // scan grid
    const grid = ws.schedule; // [day][period]
    for(let d=0; d<grid.length; d++){
      for(let p=0;p<grid[d].length;p++){
        const cell = grid[d][p];
        if(!cell) continue;
        if(cell.professorId===profId){
          // compute actual date: weekStart + d days
          const dt = new Date(wstart); dt.setDate(dt.getDate()+d);
          records.push({date: fmtDate(dt), weekday: dt.getDay(), time: cell.time || '', turma: ws.className || findById(state.classes,ws.classId)?.nome, disciplina: findById(state.subjects,cell.subjectId)?.nome||''});
        }
      }
    }
  });
  // group by month
  const area=document.getElementById('report-area'); area.innerHTML='';
  if(records.length===0){ area.innerHTML='<div class="muted">Nenhuma aula encontrada no período.</div>'; return; }
  const table = document.createElement('table');
  table.innerHTML = '<thead><tr><th>Data</th><th>Dia</th><th>Horário</th><th>Turma</th><th>Disciplina</th></tr></thead>';
  const tbody = document.createElement('tbody');
  records.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${r.date}</td><td>${['Dom','Seg','Ter','Qua','Qui','Sex','Sáb'][r.weekday]}</td><td>${r.time}</td><td>${r.turma || ''}</td><td>${r.disciplina}</td>`;
    tbody.appendChild(tr);
  });
  table.appendChild(tbody); area.appendChild(table);
}
function exportRelCSV(){
  // export same data from last generated report-area
  const area=document.getElementById('report-area'); if(!area.innerHTML){ alert('Gere o relatório antes de exportar'); return; }
  // naive: convert the table rows into CSV
  const rows = Array.from(area.querySelectorAll('table tr')).map(tr=>Array.from(tr.children).map(td=>td.textContent.replace(/;/g,',')));
  const csv = rows.map(r=>r.join(';')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'}); const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='relatorio_professor.csv'; a.click(); URL.revokeObjectURL(url);
}
function genRelTurma(){
  const classId = document.getElementById('rel-turma-list').value; if(!classId){ alert('Selecione turma'); return; }
  const start = document.getElementById('rel-t-start').value || '1900-01-01';
  const end = document.getElementById('rel-t-end').value || '2100-01-01';
  const area = document.getElementById('report-area-turma'); area.innerHTML='';
  const records = [];
  state.weeklySchedules.forEach(ws=>{
    if(ws.classId!==classId) return;
    const wstart = ws.weekStart;
    if(wstart < start || wstart > end) return;
    const grid = ws.schedule;
    for(let d=0; d<grid.length; d++){
      for(let p=0;p<grid[d].length;p++){
        const cell = grid[d][p];
        if(!cell) continue;
        const dt = new Date(wstart); dt.setDate(dt.getDate()+d);
        records.push({date: fmtDate(dt), weekday: dt.getDay(), time: cell.time || '', disciplina: findById(state.subjects,cell.subjectId)?.nome || '', professor: findById(state.professors,cell.professorId)?.nome || ''});
      }
    }
  });
  if(records.length===0){ area.innerHTML='<div class="muted">Nenhuma aula encontrada.</div>'; return; }
  const table=document.createElement('table'); table.innerHTML='<thead><tr><th>Data</th><th>Dia</th><th>Horário</th><th>Disciplina</th><th>Professor</th></tr></thead>'; const tbody=document.createElement('tbody');
  records.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.date}</td><td>${['Dom','Seg','Ter','Qua','Qui','Sex','Sáb'][r.weekday]}</td><td>${r.time}</td><td>${r.disciplina}</td><td>${r.professor}</td>`; tbody.appendChild(tr); });
  table.appendChild(tbody); area.appendChild(table);
}
function genRelDisciplina(){
  const classId = document.getElementById('rel-disc-turma').value; const discId = document.getElementById('rel-disc-list').value;
  if(!classId || !discId){ alert('Selecione turma e disciplina'); return; }
  const start = document.getElementById('rel-d-start').value || '1900-01-01';
  const end = document.getElementById('rel-d-end').value || '2100-01-01';
  const area = document.getElementById('report-area-disc'); area.innerHTML='';
  const rec = [];
  state.weeklySchedules.forEach(ws=>{
    if(ws.classId!==classId) return; if(ws.weekStart < start || ws.weekStart > end) return;
    const grid = ws.schedule;
    for(let d=0; d<grid.length; d++){
      for(let p=0;p<grid[d].length;p++){
        const cell = grid[d][p];
        if(!cell) continue; if(cell.subjectId===discId){
          const dt = new Date(ws.weekStart); dt.setDate(dt.getDate()+d);
          rec.push({date: fmtDate(dt), weekday: dt.getDay(), time: cell.time || '', professor: findById(state.professors,cell.professorId)?.nome || ''});
        }
      }
    }
  });
  if(rec.length===0){ area.innerHTML='<div class="muted">Nenhuma aula encontrada.</div>'; return; }
  const table=document.createElement('table'); table.innerHTML='<thead><tr><th>Data</th><th>Dia</th><th>Horário</th><th>Professor</th></tr></thead>'; const tbody=document.createElement('tbody');
  rec.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.date}</td><td>${['Dom','Seg','Ter','Qua','Qui','Sex','Sáb'][r.weekday]}</td><td>${r.time}</td><td>${r.professor}</td>`; tbody.appendChild(tr); });
  table.appendChild(tbody); area.appendChild(table);
}

/* ----------------- Horário Base (Generator) -------------- */
/*
  Approach:
  - For each class, expand discipline tokens by aulasSemana
  - Try to place tokens into grid of weekdays x periods (use periods according to class.turno)
  - Respect professor availability: no double booking, respect position restrictions and descanso11
  - Simple backtracking per class
*/
function populateHBSelects(){
  const sel = document.getElementById('hb-turma'); sel.innerHTML='';
  state.classes.forEach(c=>{ const o=document.createElement('option'); o.value=c.id; o.textContent=c.nome; sel.appendChild(o); });
}
function generateHorarioForSelected(single){
  if(!isLoggedAdmin()){ if(!confirm('Você não está logado como admin. Só leitura. Deseja tentar gerar (somente visual)?')) return; }
  if(single){
    const classId = document.getElementById('hb-turma').value; if(!classId){ alert('Selecione turma'); return; }
    try{ const grid = generateForClass(classId); state.baseSchedules[classId] = grid; saveAll(); renderBaseSchedules([classId]); alert('Gerado com sucesso (turma).'); }catch(e){ alert('Erro: '+e.message) }
  }else{
    const failed=[];
    state.classes.forEach(c=>{
      try{ state.baseSchedules[c.id] = generateForClass(c.id); }
      catch(e){ console.warn('fail',c.name,e.message); failed.push({turma:c.name,err:e.message}); }
    });
    saveAll(); renderBaseSchedules(); if(failed.length) alert('Algumas turmas falharam. Veja console ou messages.'); else alert('Gerado para todas as turmas.');
  }
}
function generateForClass(classId){
  const c = findById(state.classes,classId); if(!c) throw new Error('Turma não encontrada');
  // select periods based on turno
  let periodsArr = [];
  if(c.turno==='Manhã') periodsArr = state.periods.manha.filter(p=>!p.includes('INTERVALO'));
  if(c.turno==='Tarde') periodsArr = state.periods.tarde.filter(p=>!p.includes('INTERVALO'));
  if(c.turno==='Noite') periodsArr = state.periods.noite.filter(p=>!p.includes('INTERVALO'));
  if(periodsArr.length===0) {
    // fallback: 5 periods
    periodsArr = ['P1','P2','P3','P4','P5'];
  }
  // weekdays: Monday-Fri (5) for now
  const days = 5;
  const slots = days * periodsArr.length;
  // collect subjects of this class
  const subs = state.subjects.filter(s=>s.classId===classId);
  // expand tokens
  let tokens = [];
  subs.forEach(s => { for(let i=0;i<s.aulasSemana;i++) tokens.push({subjectId:s.id, professorId:s.professorId}); });
  if(tokens.length > slots) throw new Error(`Turma ${c.nome} precisa de ${tokens.length} aulas/semana, mas existem apenas ${slots} slots.`);

  // prepare grid
  const grid = Array.from({length:days}, ()=> Array.from({length:periodsArr.length}, ()=> null));
  // teacher busy map: teacherId -> Set of 'day|period'
  const teacherBusy = {};
  // helper for restrictions: given teacher and target day/period index (within day), check allowed
  function teacherAvailable(tid, dayIdx, periodIdx, turno){
    if(!tid) return true;
    const p = findById(state.professors, tid); if(!p) return true;
    const r = p.restrictions || {};
    // PRD/PGD checks: if prd === 'dia' then cannot teach any; if prd equals turno then cannot teach any in that turno (day)
    if(r.prd==='dia') return false;
    if(r.prd && r.prd.toLowerCase()===turno.toLowerCase()) return false;
    if(r.pgd==='dia') return false;
    if(r.pgd && r.pgd.toLowerCase()===turno.toLowerCase()) return false;
    // position restrictions - map periodIdx to first/last logic
    // For simplicity assume morning has indexes 0..n-1, first is index 0, first2 are 0 and 1, last is n-1, last2 are n-1 and n-2
    const n = periodsArr.length;
    if(turno==='Manhã'){
      if(r.noFirstM && periodIdx===0) return false;
      if(r.noFirst2M && (periodIdx===0 || periodIdx===1)) return false;
      if(r.noLastM && periodIdx===n-1) return false;
    }
    if(turno==='Tarde'){
      if(r.noFirstT && periodIdx===0) return false;
      if(r.noLast2T && (periodIdx===n-1 || periodIdx===n-2)) return false;
    }
    // descanso11: if teacher had night class previous day last period and now morning first period — check weeklySchedules? for base generation, apply rough rule:
    if(r.descanso11 && turno==='Manhã'){
      // check if teacherBusy has an entry for previous day and a late period index that is considered nocturnal: approximate by checking if teacherBusy contains previous day with index >= (periodsArr.length-2)
      const prevKey = (dayIdx-1)+'|'+(n-1);
      if(teacherBusy[tid] && teacherBusy[tid].has((dayIdx-1)+'|'+(n-1))) return false;
    }
    // teacher double booking
    if(teacherBusy[tid] && teacherBusy[tid].has(dayIdx+'|'+periodIdx)) return false;
    return true;
  }

  // sort tokens: those with professors first and by duplicate frequency
  const counts = {}; tokens.forEach(t=>counts[t.subjectId]=(counts[t.subjectId]||0)+1);
  tokens.sort((a,b)=>{
    if((a.professorId?1:0) !== (b.professorId?1:0)) return (b.professorId?1:0)-(a.professorId?1:0);
    return (counts[b.subjectId]||0)-(counts[a.subjectId]||0);
  });

  function place(idx){
    if(idx>=tokens.length) return true;
    const tk = tokens[idx];
    // try days & periods
    for(let d=0; d<days; d++){
      for(let p=0; p<periodsArr.length; p++){
        if(grid[d][p]) continue;
        // check teacher availability
        const turno = c.turno;
        if(!teacherAvailable(tk.professorId,d,p,turno)) continue;
        // place
        grid[d][p] = { subjectId: tk.subjectId, professorId: tk.professorId, time: periodsArr[p].includes('INTERVALO')?periodsArr[p]:(periodsArr[p]||('P'+(p+1))) };
        if(tk.professorId){
          teacherBusy[tk.professorId] = teacherBusy[tk.professorId] || new Set();
          teacherBusy[tk.professorId].add(d+'|'+p);
        }
        if(place(idx+1)) return true;
        // backtrack
        grid[d][p] = null;
        if(tk.professorId) teacherBusy[tk.professorId].delete(d+'|'+p);
      }
    }
    return false;
  }

  const ok = place(0);
  if(!ok) throw new Error('Impossível alocar disciplinas com as restrições atuais para turma ' + c.nome);
  return grid;
}

function renderBaseSchedules(filterIds=[]){
  const area = document.getElementById('hb-area'); area.innerHTML='';
  const keys = filterIds.length ? filterIds : Object.keys(state.baseSchedules);
  if(keys.length===0){ area.innerHTML='<div class="muted">Nenhum horário base gerado.</div>'; return; }
  keys.forEach(cid=>{
    const grid = state.baseSchedules[cid];
    if(!grid) return;
    const cls = findById(state.classes,cid);
    const card = document.createElement('div'); card.className='card'; card.style.marginBottom='12px';
    const title = document.createElement('h3'); title.textContent = 'Turma: ' + (cls?.nome || cid);
    card.appendChild(title);
    const tbl = document.createElement('table');
    const thead = document.createElement('thead');
    const trh = document.createElement('tr');
    trh.innerHTML = '<th>Período/Dia</th>';
    // days header Mon-Fri
    const dayNames = ['Seg','Ter','Qua','Qui','Sex'];
    dayNames.forEach(dn=>{ const th=document.createElement('th'); th.textContent=dn; trh.appendChild(th); });
    thead.appendChild(trh); tbl.appendChild(thead);
    const tbody = document.createElement('tbody');
    const nPeriods = grid[0].length;
    for(let p=0;p<nPeriods;p++){
      const tr = document.createElement('tr');
      tr.appendChild(document.createElement('th')); tr.firstChild.textContent = 'P ' + (p+1);
      for(let d=0; d<grid.length; d++){
        const td = document.createElement('td');
        const c = grid[d][p];
        if(c){
          const subj = findById(state.subjects,c.subjectId);
          const prof = findById(state.professors,c.professorId);
          td.innerHTML = `<strong>${subj?subj.nome:'(disc.)'}</strong><div class="muted">${prof?prof.nome:''}</div>`;
        } else td.textContent = '-';
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
    }
    tbl.appendChild(tbody); card.appendChild(tbl); area.appendChild(card);
  });
}

/* ----------------- Weekly schedules create/edit ----------------- */
function populateWSSelects(){
  const sel = document.getElementById('ws-turma'); sel.innerHTML='';
  state.classes.forEach(c=>{ const o = document.createElement('option'); o.value=c.id; o.textContent=c.nome; sel.appendChild(o); });
}
function createWeekInstance(){
  if(!isLoggedAdmin()){ if(!confirm('Você não é admin. Criar semana exigirá permissão. Deseja prosseguir (apenas visual)?')) return; }
  const start = document.getElementById('ws-start').value; if(!start){ alert('Informe início da semana'); return; }
  const classId = document.getElementById('ws-turma').value; if(!classId){ alert('Informe turma'); return; }
  // take base schedule and save as weekly instance
  const base = state.baseSchedules[classId];
  if(!base){ alert('Não existe horário base para a turma selecionada. Gere antes.'); return; }
  const clone = JSON.parse(JSON.stringify(base));
  const ws = { id: uid('ws'), classId, weekStart: start, schedule: clone };
  // attach className for easier reporting
  ws.className = findById(state.classes,classId)?.nome || '';
  state.weeklySchedules.push(ws); saveAll();
  renderWeekly(ws);
}
function renderWeekly(ws){
  const area = document.getElementById('ws-area');
  // append one card for the week
  const card = document.createElement('div'); card.className='card';
  card.innerHTML = `<h3>Semana: ${ws.weekStart} • Turma: ${ws.className}</h3>`;
  const tbl = document.createElement('table');
  const thead = document.createElement('thead'); const trh = document.createElement('tr');
  trh.innerHTML = '<th>Período/Dia</th>';
  const dayNames = ['Seg','Ter','Qua','Qui','Sex'];
  dayNames.forEach(dn=>{ const th=document.createElement('th'); th.textContent=dn; trh.appendChild(th); });
  thead.appendChild(trh); tbl.appendChild(thead);
  const tbody = document.createElement('tbody');
  const grid = ws.schedule;
  for(let p=0;p<grid[0].length;p++){
    const tr = document.createElement('tr');
    tr.appendChild(document.createElement('th')); tr.firstChild.textContent = 'P ' + (p+1);
    for(let d=0; d<grid.length; d++){
      const td = document.createElement('td');
      const cell = grid[d][p];
      if(cell){
        const subj = findById(state.subjects, cell.subjectId);
        const prof = findById(state.professors, cell.professorId);
        td.innerHTML = `<div><strong>${subj?subj.nome:'(disc.)'}</strong></div><div class="muted">${prof?prof.nome:''}</div>`;
      } else td.textContent = '-';
      // allow edit cell on click if admin
      td.style.cursor = 'pointer';
      td.onclick = ()=>editWeeklyCell(ws.id,d,p);
      tr.appendChild(td);
    }
    tbody.appendChild(tr);
  }
  tbl.appendChild(tbody); card.appendChild(tbl);
  const btnSave = document.createElement('button'); btnSave.className='btn primary'; btnSave.textContent='Salvar semana'; btnSave.style.marginTop='8px';
  btnSave.onclick = ()=>{ if(!isLoggedAdmin()){ alert('Somente admin'); return; } saveAll(); alert('Semana salva'); };
  const btnDel = document.createElement('button'); btnDel.className='btn'; btnDel.style.marginLeft='8px'; btnDel.textContent='Remover semana';
  btnDel.onclick = ()=>{ if(confirm('Remover semana?')){ state.weeklySchedules = state.weeklySchedules.filter(x=>x.id!==ws.id); saveAll(); area.removeChild(card); } };
  card.appendChild(btnSave); card.appendChild(btnDel);
  area.appendChild(card);
}
function editWeeklyCell(wsId, dayIdx, periodIdx){
  const ws = findById(state.weeklySchedules, wsId); if(!ws) return;
  // picker modal: choose discipline from that class
  const available = state.subjects.filter(s=>s.classId===ws.classId);
  const sel = prompt('Selecione disciplina por índice:\\n' + available.map((a,i)=>`${i+1} - ${a.nome} (${a.aulasSemana} aulas/semana)`).join('\\n') + '\\n0 - limpar');
  if(sel===null) return;
  const idx = parseInt(sel)||0;
  if(idx===0){ ws.schedule[dayIdx][periodIdx]=null; saveAll(); alert('removido'); return; }
  const subj = available[idx-1];
  if(!subj){ alert('Índice inválido'); return; }
  // assign professor if subj has professor
  ws.schedule[dayIdx][periodIdx] = { subjectId: subj.id, professorId: subj.professorId || null, time: '' };
  saveAll(); alert('Alterado'); // re-render: simple full render
  document.getElementById('ws-area').innerHTML=''; state.weeklySchedules.forEach(w=>renderWeekly(w));
}

/* ----------------- Admin users management ----------------- */
function populateUsersList(){
  const el = document.getElementById('list-users'); el.innerHTML='';
  state.users.forEach(u=>{
    const div=document.createElement('div'); div.className='item';
    const left=document.createElement('div'); left.innerHTML=`<strong>${u.username}</strong><div class="muted">${u.role}</div>`;
    const right=document.createElement('div');
    const del=document.createElement('button'); del.className='smallBtn'; del.textContent='Remover'; del.onclick=()=>{ if(!isLoggedAdmin()){ alert('Apenas admin'); showLogin(); return; } if(confirm('Remover usuário?')){ state.users=state.users.filter(x=>x.username!==u.username); saveAll(); populateUsersList(); } };
    right.appendChild(del); div.appendChild(left); div.appendChild(right); el.appendChild(div);
  });
}
function createUser(){
  if(!isLoggedAdmin()){ alert('Somente admin'); showLogin(); return; }
  const username = document.getElementById('admin-user').value.trim();
  const pass = document.getElementById('admin-pass').value.trim();
  const role = document.getElementById('admin-role').value;
  if(!username || !pass){ alert('Informe usuário e senha'); return; }
  if(state.users.find(u=>u.username===username)){ alert('Usuário já existe'); return; }
  state.users.push({username, password: pass, role}); saveAll(); populateUsersList(); document.getElementById('admin-user').value=''; document.getElementById('admin-pass').value='';
}

/* ----------------- Auth ----------------- */
function showLogin(){ document.getElementById('modal-login').classList.remove('hidden'); document.getElementById('modal-login').ariaHidden='false'; }
function hideLogin(){ document.getElementById('modal-login').classList.add('hidden'); document.getElementById('modal-login').ariaHidden='true'; }
function loginSubmit(){
  const u = document.getElementById('login-username').value.trim();
  const p = document.getElementById('login-password').value;
  const user = state.users.find(x=>x.username===u && x.password===p);
  const msg = document.getElementById('login-msg'); if(!user){ msg.textContent='Credenciais inválidas'; msg.classList.add('danger'); return; }
  state.currentUser = {username: user.username, role: user.role}; saveAll(); hideLogin(); renderUI();
}
function logout(){ state.currentUser=null; saveAll(); renderUI(); }
function isLoggedAdmin(){ return state.currentUser && state.currentUser.role==='admin'; }
function showLoginIfNeeded(){ // if not logged, show modal prompt on first use
  if(!state.currentUser){ showLogin(); }
}

/* ----------------- Rendering helpers ----------------- */
function renderUI(){
  document.getElementById('userInfo').textContent = state.currentUser ? `Usuário: ${state.currentUser.username} (${state.currentUser.role})` : 'Não autenticado';
  document.getElementById('btn-logout').style.display = state.currentUser ? 'inline-block' : 'none';
  // render lists
  renderProfessorList(); renderDisciplinas(); renderTurmas(); renderCalendars(); populateDiscSelects(); updateStats(); populateUsersList();
  // weekly render area
  document.getElementById('ws-area').innerHTML=''; state.weeklySchedules.forEach(w=>renderWeekly(w));
  // base schedule render if any
  renderBaseSchedules();
}
function populateProfList(){
  const el = document.getElementById('disc-professor'); el.innerHTML='<option value="">-- escolher --</option>';
  state.professors.forEach(p=>{ const o=document.createElement('option'); o.value=p.id; o.textContent=p.nome; el.appendChild(o); });
  // rel professor select
  const r=document.getElementById('rel-prof-list'); if(r) r.innerHTML = '<option value="">-- selecione --</option>'; state.professors.forEach(p=>{ if(r){ const o=document.createElement('option'); o.value=p.id; o.textContent=p.nome; r.appendChild(o); }});
}
function populateClassList(){
  const el = document.getElementById('disc-turma'); if(el) { el.innerHTML=''; state.classes.forEach(c=>{ const o=document.createElement('option'); o.value=c.id; o.textContent=c.nome; el.appendChild(o); }); }
}
function updateStats(){
  document.getElementById('stat-prof-count').textContent = state.professors.length;
  document.getElementById('stat-subj-count').textContent = state.subjects.length;
  document.getElementById('stat-class-count').textContent = state.classes.length;
}

/* ----------------- Misc utilities ----------------- */
function print(){ window.print(); }

/* ----------------- Misc bootstrapping ----------------- */
// first render of some lists:
renderUI();

/* ----------------- End of script ----------------- */
</script>
</body>
</html>

