<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SGP - IFRO Campus Cacoal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .tab-btn.active { border-bottom: 4px solid #15803d; color: #15803d; font-weight: 800; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }
        
        table { width: 100%; border-collapse: collapse; }
        th { font-size: 14px !important; font-weight: 700 !important; text-transform: uppercase; padding: 12px 8px !important; }
        td { font-size: 12px !important; padding: 8px !important; }
        .tableGS { table-layout: fixed; width: 100%; }
        .tableGS td, .tableGS th { word-wrap: break-word; vertical-align: middle; text-align: center; border: 1px solid #e5e7eb; }
        .aula-card { padding: 4px; margin: 1px; border-radius: 4px; line-height: 1.1; border-left: 3px solid #15803d; text-align: center; font-size: 10px; }
        .status-normal { background-color: #f0fdf4; border-color: #15803d; }
        .status-extra { background-color: #ecfdf5; border-color: #059669; color: #065f46; }
        .status-reposicao { background-color: #eff6ff; border-color: #2563eb; color: #1e40af; }
        .status-rec { background-color: #fdf2f8; border-color: #db2777; color: #9d174d; }
        .status-exame { background-color: #f5f5f5; border-color: #4b5563; color: #1f2937; }
        .intervalo-row { background-color: #f3f4f6 !important; color: #6b7280; font-weight: bold; text-transform: uppercase; font-size: 10px; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <header class="bg-[#15803d] text-white p-6 shadow-lg">
        <div class="container mx-auto flex flex-col md:flex-row justify-between items-center">
            <div>
                <h1 class="text-2xl font-black italic uppercase tracking-tighter">INSTITUTO FEDERAL DE RONDÔNIA - IFRO</h1>
                <p class="text-xs font-bold opacity-80 uppercase">CAMPUS CACOAL</p>
                <p class="text-xs font-bold opacity-80 uppercase">DEPARTAMENTO DE APOIO AO ENSINO</p>
                <p class="mt-2 text-sm font-black uppercase border-t border-white/20 pt-1">SISTEMA DE GESTÃO PEDAGÓGICA</p>
            </div>
            <div class="flex items-center gap-4 mt-4 md:mt-0">
                <div class="flex flex-col">
                    <label class="text-[10px] font-bold opacity-70">ANO LETIVO</label>
                    <select id="yearSelect" class="bg-white/20 border border-white/30 p-1 rounded text-white font-bold outline-none cursor-pointer">
                        <option value="2025" class="text-black" selected>2025</option>
                        <option value="2026" class="text-black">2026</option>
                    </select>
                </div>
                <div id="dataRelatorio" class="bg-white/10 px-4 py-2 rounded-lg font-mono text-sm border border-white/20">--/--/----</div>
            </div>
        </div>
    </header>

    <nav class="bg-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto flex overflow-x-auto">
            <button class="tab-btn px-6 py-4 active" data-tab="tab-disciplina">RELATÓRIO POR DISCIPLINA</button>
            <button class="tab-btn px-6 py-4" data-tab="tab-turma">RELATÓRIO POR TURMA</button>
            <button class="tab-btn px-6 py-4" data-tab="tab-semanal">RELATÓRIO SEMANAL POR PROFESSOR</button>
            <button class="tab-btn px-6 py-4" data-tab="tab-semanal-turma">RELATÓRIO SEMANAL POR TURMA</button>
            <button class="tab-btn px-6 py-4" data-tab="tab-info">INFORMAÇÕES DO SISTEMA</button>
        </div>
    </nav>

    <main class="container mx-auto p-4 md:p-6">
        <div id="loading" class="text-center py-10 font-bold text-green-700 italic animate-pulse">CARREGANDO DADOS...</div>

        <section id="tab-disciplina" class="tab-pane active">
            <div class="bg-white p-6 rounded-xl shadow-sm border">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <select id="turmaSelect" class="p-3 border rounded-lg font-bold bg-gray-50"></select>
                    <select id="semestreSelect" class="p-3 border rounded-lg font-bold bg-blue-50 border-blue-200 hidden">
                        <option value="1">1º SEMESTRE</option>
                        <option value="2">2º SEMESTRE</option>
                    </select>
                    <select id="disciplinaSelect" class="p-3 border rounded-lg bg-gray-50" disabled><option>Selecione a Turma</option></select>
                </div>
                <div id="resultadoBusca" class="hidden">
                    <div class="flex flex-wrap gap-4 mb-4 items-center">
                        <div class="bg-green-100 p-4 rounded-lg border border-green-200 text-center flex-1">
                            <p class="text-[10px] font-bold text-green-800">AULAS REGULARES</p>
                            <span id="cont-regular" class="text-2xl font-black text-green-900">0</span>
                        </div>
                        <div class="bg-pink-100 p-4 rounded-lg border border-pink-200 text-center flex-1">
                            <p class="text-[10px] font-bold text-pink-800">RECUPERAÇÃO/EXAME</p>
                            <span id="cont-extra" class="text-2xl font-black text-pink-900">0</span>
                        </div>
                        <button onclick="exportarDisciplinaPDF()" class="bg-[#15803d] text-white px-8 py-4 rounded-lg font-bold hover:bg-green-800 transition shadow-md uppercase">Exportar PDF Disciplina</button>
                    </div>
                    <table id="tableD" class="min-w-full bg-white border text-center">
                        <thead class="bg-gray-50">
                            <tr><th class="border">DATA</th><th class="border">DIA</th><th class="border">HORÁRIO</th><th class="border">PROFESSOR</th><th class="border">STATUS</th></tr>
                        </thead>
                        <tbody id="bodyD"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="tab-turma" class="tab-pane">
            <div class="bg-white p-6 rounded-xl shadow-sm border">
                <div class="flex gap-4 mb-6">
                    <select id="turmaSelectPivo" class="p-3 border rounded-lg font-bold flex-1 bg-gray-50"></select>
                    <select id="semestreSelectPivo" class="p-3 border rounded-lg font-bold bg-blue-50 border-blue-200 hidden">
                        <option value="1">1º SEMESTRE</option>
                        <option value="2">2º SEMESTRE</option>
                    </select>
                    <button onclick="exportarPivoPDF()" class="bg-[#15803d] text-white px-8 rounded-lg font-bold hover:bg-green-800 transition shadow-md uppercase">Exportar PDF Turma</button>
                </div>
                <div class="overflow-x-auto">
                    <table id="tablePivo" class="min-w-full border text-center">
                        <thead class="bg-[#15803d] text-white">
                            <tr>
                                <th class="text-left w-64">DISCIPLINA</th>
                                <th>JAN</th><th>FEV</th><th>MAR</th><th>ABR</th><th>MAI</th><th>JUN</th><th>JUL</th><th>AGO</th><th>SET</th><th>OUT</th><th>NOV</th><th>DEZ</th>
                                <th class="bg-green-600">TOTAL</th>
                            </tr>
                        </thead>
                        <tbody id="bodyPivo" class="bg-white font-bold"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="tab-semanal" class="tab-pane">
            <div class="bg-white p-6 rounded-xl shadow-sm border">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <select id="profSelect" class="p-3 border rounded-lg font-bold bg-gray-50"></select>
                    <input type="week" id="weekInput" class="p-3 border rounded-lg">
                    <div class="flex gap-2">
                        <button onclick="gerarGrade()" class="bg-blue-600 text-white font-bold rounded-lg flex-1 hover:bg-blue-700 transition uppercase text-xs">Ver Grade</button>
                        <button onclick="exportarGradePDF()" class="bg-[#15803d] text-white font-bold rounded-lg flex-1 hover:bg-green-800 transition shadow-md uppercase text-xs">Exportar PDF Grade</button>
                    </div>
                </div>
                <div id="gradeRender" class="overflow-x-auto border rounded-lg"></div>
            </div>
        </section>

        <section id="tab-semanal-turma" class="tab-pane">
            <div class="bg-white p-6 rounded-xl shadow-sm border">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <select id="turmaSelectSemanal" class="p-3 border rounded-lg font-bold bg-gray-50"></select>
                    <input type="week" id="weekInputTurma" class="p-3 border rounded-lg">
                    <div class="flex gap-2">
                        <button onclick="gerarGradeTurma()" class="bg-blue-600 text-white font-bold rounded-lg flex-1 hover:bg-blue-700 transition uppercase text-xs">Ver Grade Turma</button>
                        <button onclick="exportarGradeTurmaPDF()" class="bg-[#15803d] text-white font-bold rounded-lg flex-1 hover:bg-green-800 transition shadow-md uppercase text-xs">Exportar PDF Grade</button>
                    </div>
                </div>
                <div id="gradeTurmaRender" class="overflow-x-auto border rounded-lg"></div>
            </div>
        </section>

        <section id="tab-info" class="tab-pane">
            <div class="bg-white p-6 rounded-xl shadow-sm border">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="space-y-4">
                        <h3 class="text-[#15803d] font-black border-b-2 border-green-700 pb-2 uppercase text-sm">Estrutura Organizacional</h3>
                        <div class="space-y-2 text-xs">
                            <p><strong>INSTITUIÇÃO:</strong> Instituto Federal de Rondônia - IFRO</p>
                            <p><strong>CAMPUS:</strong> Cacoal</p>
                            <p><strong>DEPARTAMENTO:</strong> Departamento de Apoio ao Ensino (DAPE)</p>
                            <p><strong>COORDENAÇÃO:</strong> Coordenação de Desenvolvimento de Ferramentas Pedagógicas</p>
                        </div>
                        <h3 class="text-[#15803d] font-black border-b-2 border-green-700 pb-2 pt-4 uppercase text-sm">Contato e Localização</h3>
                        <div class="space-y-2 text-xs">
                            <p><strong>ENDEREÇO:</strong> BR-364, Km 228, Lote 2-A, Zona Rural, Cacoal - RO</p>
                            <p><strong>TELEFONE:</strong> (69) 3443-9501</p>
                            <p><strong>E-MAIL:</strong> dape.cacoal@ifro.edu.br</p>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-6 rounded-lg border border-dashed border-gray-300 text-center">
                        <h3 class="text-gray-700 font-black mb-4 uppercase text-sm">Calendário Acadêmico - <span id="infoYear">2025</span></h3>
                        <div class="space-y-4 text-left">
                            <div class="bg-white p-4 rounded shadow-sm border-l-4 border-blue-500">
                                <p class="text-[10px] font-bold text-gray-500 uppercase">1º Semestre</p>
                                <p id="semestre1" class="text-base font-black text-gray-800"></p>
                            </div>
                            <div class="bg-white p-4 rounded shadow-sm border-l-4 border-green-500">
                                <p class="text-[10px] font-bold text-gray-500 uppercase">2º Semestre</p>
                                <p id="semestre2" class="text-base font-black text-gray-800"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script>
        // --- CONFIGURAÇÃO DE DATAS POR ANO (AJUSTE AQUI OS LIMITES REAIS) ---
        const CALENDARIOS = {
    "2025": {
        s1: { inicio: new Date(2025, 1, 1, 0, 0, 0), fim: new Date(2025, 7, 12, 23, 59, 59) }, 
        s2: { inicio: new Date(2025, 7, 27, 0, 0, 0), fim: new Date(2025, 12, 31, 23, 59, 59) }
    },
    "2026": {
        s1: { inicio: new Date(2026, 1, 2, 0, 0, 0), fim: new Date(2026, 6, 10, 23, 59, 59) },
        s2: { inicio: new Date(2026, 6, 27, 0, 0, 0), fim: new Date(2026, 11, 22, 23, 59, 59) }
    }
};

        const CURSOS_SEMESTRAIS = ["GEOGRAFIA", "MATEMÁTICA", "AGRONEGÓCIO", "ZOOTECNIA", "AGRONOMIA"];
        const TRADUCAO = { 
            "+": { texto: "EXTRA", class: "status-extra", soma: true },
            "R": { texto: "REPOSIÇÃO", class: "status-reposicao", soma: true },
            "REC": { texto: "RECUPERAÇÃO", class: "status-rec", soma: false },
            "EX": { texto: "EXAME", class: "status-exame", soma: false }
        };

        const GABARITO = [
            {h:"07:30 - 08:20", t:"aula"}, {h:"08:20 - 09:10", t:"aula"}, 
            {h:"09:10 - 09:30", t:"intervalo", l:"INTERVALO MATUTINO"},
            {h:"09:30 - 10:20", t:"aula"}, {h:"10:20 - 11:10", t:"aula"}, {h:"11:10 - 12:00", t:"aula"},
            {h:"12:00 - 13:50", t:"intervalo", l:"ALMOÇO"},
            {h:"13:50 - 14:40", t:"aula"}, {h:"14:40 - 15:30", t:"aula"},
            {h:"15:30 - 15:50", t:"intervalo", l:"INTERVALO VESPERTINO"},
            {h:"15:50 - 16:40", t:"aula"}, {h:"16:40 - 17:30", t:"aula"}, {h:"17:30 - 18:20", t:"aula"},
            {h:"18:20 - 19:00", t:"intervalo", l:"JANTAR"},
            {h:"19:00 - 19:50", t:"aula"}, {h:"19:50 - 20:40", t:"aula"},
            {h:"20:40 - 20:50", t:"intervalo", l:"INTERVALO NOTURNO"},
            {h:"20:50 - 21:40", t:"aula"}, {h:"21:40 - 22:30", t:"aula"}
        ];

        let dataStore = {};
        const GIST_URL = "https://gist.githubusercontent.com/jamilsalim-afk/15207392062fe2b7f6fbd0a788e8d99c/raw/56c9d463688529c2b2f765887ef1422e56f9bf51/DADOS_2026_MESTRE";

        window.onload = () => {
            document.getElementById('dataRelatorio').textContent = new Date().toLocaleDateString('pt-BR');
            carregarDados();
            initTabs();
            document.getElementById('yearSelect').onchange = carregarDados;
        };

        function ehSemestral(tId) {
            if(!dataStore[tId]) return false;
            const nome = dataStore[tId].name.toUpperCase();
            return CURSOS_SEMESTRAIS.some(c => nome.includes(c));
        }

        async function carregarDados() {
    try {
        const yearSelected = document.getElementById('yearSelect').value;
        const cal = CALENDARIOS[yearSelected];
        
        document.getElementById('infoYear').textContent = yearSelected;
        document.getElementById('semestre1').textContent = `${cal.s1.inicio.toLocaleDateString('pt-BR')} a ${cal.s1.fim.toLocaleDateString('pt-BR')}`;
        document.getElementById('semestre2').textContent = `${cal.s2.inicio.toLocaleDateString('pt-BR')} a ${cal.s2.fim.toLocaleDateString('pt-BR')}`;

        document.getElementById('loading').classList.remove('hidden');
        const res = await fetch(GIST_URL + "?t=" + new Date().getTime());
        let csv = await res.text();
        csv = csv.replace(/(AGRONOMIA)(\d)/g, "$1\n$2");
        const lines = csv.split(/\r?\n/).filter(l => l.trim().length > 0);
        const headers = lines[0].split(';').map(h => h.trim());
        const turmas = headers.slice(2);
        dataStore = {};
        let lastDate = "";

        lines.slice(1).forEach(line => {
            const cols = line.split(';').map(c => c?.trim());
            if (cols[0] && cols[0].length > 0) { lastDate = cols[0].replace(/\./g, '/'); }

            if (!cols[1] || !lastDate || !lastDate.includes(`/${yearSelected}`)) return;

            turmas.forEach((tNome, idx) => {
                const cell = cols[idx + 2];
                if (!cell || cell === "" || cell === "0" || cell.length < 3) return;
                
                const tId = tNome.toLowerCase().replace(/[^a-z0-9]/g, '');
                const tagM = cell.match(/\[(.*?)\]/);
                const tag = tagM ? tagM[1].toUpperCase() : null;
                const cleanT = tagM ? cell.replace(tagM[0], "").trim() : cell;
                
                let disc, prof;
                if (cleanT.includes(' - ')) {
                    const partes = cleanT.split(' - ');
                    prof = partes.pop().trim();
                    disc = partes.join(' - ').trim();
                } else { disc = cleanT; prof = "N/I"; }
                
                if (!dataStore[tId]) dataStore[tId] = { name: tNome, discs: {} };
                const dId = disc.toLowerCase().replace(/[^a-z0-9]/g, '');
                if (!dataStore[tId].discs[dId]) dataStore[tId].discs[dId] = { name: disc, sch: [] };
                
                // CRIAÇÃO DA DATA COM OFFSET DE MEIO-DIA (SEGURANÇA)
                const p = lastDate.split('/');
                const dt = new Date(parseInt(p[2]), parseInt(p[1]) - 1, parseInt(p[0]), 12, 0, 0);
                
                dataStore[tId].discs[dId].sch.push({ 
                    date: lastDate, 
                    dtObj: dt, 
                    wd: dt.toLocaleDateString('pt-BR', { weekday: 'long' }), 
                    time: cols[1], prof: prof, tag: tag 
                });
            });
        });
        document.getElementById('loading').classList.add('hidden');
        popularSelects();
        limparResultados();
    } catch (e) { 
        console.error(e);
        document.getElementById('loading').innerHTML = "Erro ao sincronizar."; 
    }
}

        // LÓGICA DE RENDERIZAÇÃO COM FILTRO CRONOLÓGICO POR DIA/MÊS
        function renderD() {
    const tId = document.getElementById('turmaSelect').value;
    const dId = document.getElementById('disciplinaSelect').value;
    const sem = document.getElementById('semestreSelect').value;
    const year = document.getElementById('yearSelect').value;
    const cal = CALENDARIOS[year];
    const b = document.getElementById('bodyD');
    
    if(!tId || !dId) return;
    b.innerHTML = ''; let sR = 0, sE = 0;

    const limiteS1 = cal.s1.fim.getTime();

    dataStore[tId].discs[dId].sch.forEach(a => {
        let filtrar = true;
        const tempoAula = a.dtObj.getTime();

        if(ehSemestral(tId)) {
            // Se sem "1", pega tudo até o limite do fim do S1. Se "2", pega o que for depois.
            filtrar = (sem === "1") ? (tempoAula <= limiteS1) : (tempoAula > limiteS1);
        }

        if(filtrar) {
            const info = TRADUCAO[a.tag] || {texto:"NORMAL", class:"", soma:true};
            if(info.soma) sR++; else sE++;
            b.innerHTML += `<tr class="${info.class}">
                <td class="border">${a.date}</td>
                <td class="border uppercase">${a.wd}</td>
                <td class="border">${a.time}</td>
                <td class="border font-bold">${a.prof}</td>
                <td class="border font-black">${info.texto}</td>
            </tr>`;
        }
    });
    document.getElementById('cont-regular').textContent = sR;
    document.getElementById('cont-extra').textContent = sE;
    document.getElementById('resultadoBusca').classList.remove('hidden');
}

function renderPivo() {
    const tId = document.getElementById('turmaSelectPivo').value;
    const sem = document.getElementById('semestreSelectPivo').value;
    const year = document.getElementById('yearSelect').value;
    const cal = CALENDARIOS[year];
    const b = document.getElementById('bodyPivo');
    
    if(!tId) return;
    b.innerHTML = '';
    const limiteS1 = cal.s1.fim.getTime();

    for(let dId in dataStore[tId].discs) {
        let mCount = Array(12).fill(0);
        let temNoSem = false;
        
        dataStore[tId].discs[dId].sch.forEach(s => {
            let filtrar = true;
            const tempoAula = s.dtObj.getTime();

            if(ehSemestral(tId)) {
                filtrar = (sem === "1") ? (tempoAula <= limiteS1) : (tempoAula > limiteS1);
            }
            
            if(filtrar) { 
                mCount[s.dtObj.getMonth()]++; 
                temNoSem = true; 
            }
        });

        if(temNoSem) {
            let row = `<tr class="border-b"><td class="text-left font-black border-r bg-gray-50 text-[#15803d] uppercase">${dataStore[tId].discs[dId].name}</td>`;
            mCount.forEach(c => row += `<td class="border-r">${c||'-'}</td>`);
            row += `<td class="bg-green-100 text-green-900 font-black">${mCount.reduce((a,b)=>a+b)}</td></tr>`;
            b.innerHTML += row;
        }
    }
}
        
        function limparResultados() {
            document.getElementById('resultadoBusca').classList.add('hidden');
            document.getElementById('bodyPivo').innerHTML = '';
            document.getElementById('gradeRender').innerHTML = '';
            document.getElementById('gradeTurmaRender').innerHTML = '';
            document.getElementById('disciplinaSelect').disabled = true;
            document.getElementById('disciplinaSelect').innerHTML = '<option>Selecione a Turma</option>';
            document.getElementById('semestreSelect').classList.add('hidden');
            document.getElementById('semestreSelectPivo').classList.add('hidden');
        }

        function popularSelects() {
            const t1 = document.getElementById('turmaSelect');
            const t2 = document.getElementById('turmaSelectPivo');
            const t3 = document.getElementById('turmaSelectSemanal');
            const ps = document.getElementById('profSelect');
            const profs = new Set();
            const optionsHtml = '<option value="">-- SELECIONE A TURMA --</option>' + Object.keys(dataStore).sort().map(id => `<option value="${id}">${dataStore[id].name}</option>`).join('');
            t1.innerHTML = optionsHtml; t2.innerHTML = optionsHtml; t3.innerHTML = optionsHtml;
            for(let t in dataStore) for(let d in dataStore[t].discs) dataStore[t].discs[d].sch.forEach(x => { if(x.prof && x.prof !== "N/I") profs.add(x.prof); });
            ps.innerHTML = '<option value="">-- PROFESSOR --</option>' + Array.from(profs).sort().map(p => `<option value="${p}">${p}</option>`).join('');
        }

        document.getElementById('turmaSelect').onchange = (e) => {
            const tId = e.target.value;
            const semS = document.getElementById('semestreSelect');
            if(ehSemestral(tId)) semS.classList.remove('hidden'); else semS.classList.add('hidden');
            atualizarListaDisciplinas();
        };

        document.getElementById('semestreSelect').onchange = atualizarListaDisciplinas;

        function atualizarListaDisciplinas() {
            const tId = document.getElementById('turmaSelect').value;
            const sem = document.getElementById('semestreSelect').value;
            const dS = document.getElementById('disciplinaSelect');
            dS.innerHTML = '<option value="">-- SELECIONE A DISCIPLINA --</option>';
            if(dataStore[tId]) {
                Object.keys(dataStore[tId].discs).sort().forEach(id => {
                    const aulas = dataStore[tId].discs[id].sch;
                    const temAulaNoSem = aulas.some(a => {
                        const year = document.getElementById('yearSelect').value;
const cal = CALENDARIOS[year];
const limiteS1 = cal.s1.fim.getTime();
const tempoAula = a.dtObj.getTime();

return ehSemestral(tId)
    ? (sem === "1" ? tempoAula <= limiteS1 : tempoAula > limiteS1)
    : true;
                    });
                    if(temAulaNoSem) dS.innerHTML += `<option value="${id}">${dataStore[tId].discs[id].name}</option>`;
                });
                dS.disabled = false;
            }
            renderD();
        }

        document.getElementById('disciplinaSelect').onchange = renderD;

        function renderD() {
            const tId = document.getElementById('turmaSelect').value;
            const dId = document.getElementById('disciplinaSelect').value;
            const sem = document.getElementById('semestreSelect').value;
            const b = document.getElementById('bodyD');
            if(!tId || !dId) return;
            b.innerHTML = ''; let sR = 0, sE = 0;
            dataStore[tId].discs[dId].sch.forEach(a => {
                const year = document.getElementById('yearSelect').value;
const cal = CALENDARIOS[year];
const limiteS1 = cal.s1.fim.getTime();
const tempoAula = a.dtObj.getTime();

const filtrar = ehSemestral(tId)
    ? (sem === "1" ? tempoAula <= limiteS1 : tempoAula > limiteS1)
    : true;
                if(filtrar) {
                    const info = TRADUCAO[a.tag] || {texto:"NORMAL", class:"", soma:true};
                    if(info.soma) sR++; else sE++;
                    b.innerHTML += `<tr class="${info.class}"><td class="border">${a.date}</td><td class="border uppercase">${a.wd}</td><td class="border">${a.time}</td><td class="border font-bold">${a.prof}</td><td class="border font-black">${info.texto}</td></tr>`;
                }
            });
            document.getElementById('cont-regular').textContent = sR;
            document.getElementById('cont-extra').textContent = sE;
            document.getElementById('resultadoBusca').classList.remove('hidden');
        }

        document.getElementById('turmaSelectPivo').onchange = (e) => {
            const tId = e.target.value;
            const semS = document.getElementById('semestreSelectPivo');
            if(ehSemestral(tId)) semS.classList.remove('hidden'); else semS.classList.add('hidden');
            renderPivo();
        };

        document.getElementById('semestreSelectPivo').onchange = renderPivo;

        function renderPivo() {
            const tId = document.getElementById('turmaSelectPivo').value;
            const sem = document.getElementById('semestreSelectPivo').value;
            const b = document.getElementById('bodyPivo');
            if(!tId) return;
            b.innerHTML = '';
            for(let dId in dataStore[tId].discs) {
                let mCount = Array(12).fill(0);
                let temNoSem = false;
                dataStore[tId].discs[dId].sch.forEach(s => {
                    const year = document.getElementById('yearSelect').value;
const cal = CALENDARIOS[year];
const limiteS1 = cal.s1.fim.getTime();
const tempoAula = s.dtObj.getTime();

const filtrar = ehSemestral(tId)
    ? (sem === "1" ? tempoAula <= limiteS1 : tempoAula > limiteS1)
    : true;

if(filtrar) { 
    const m = s.dtObj.getMonth();
    mCount[m]++; 
    temNoSem = true; 
}
                });
                if(temNoSem) {
                    let row = `<tr class="border-b"><td class="text-left font-black border-r bg-gray-50 text-[#15803d] uppercase">${dataStore[tId].discs[dId].name}</td>`;
                    mCount.forEach(c => row += `<td class="border-r">${c||'-'}</td>`);
                    row += `<td class="bg-green-100 text-green-900 font-black">${mCount.reduce((a,b)=>a+b)}</td></tr>`;
                    b.innerHTML += row;
                }
            }
        }

        function gerarGrade() {
            const prof = document.getElementById('profSelect').value;
            const week = document.getElementById('weekInput').value;
            if(!prof || !week) return alert("Selecione Professor e Semana");
            const [y, w] = week.split('-W').map(Number);
            const start = getStartOfWeek(w, y);
            const dias = ["Segunda", "Terça", "Quarta", "Quinta", "Sexta", "Sábado"];
            
            let aulasPorDia = Array(6).fill(0);
            let horasPermanencia = Array(6).fill(0);
            let observacoes = [];
            let ultimaAulaDiaAnterior = null;

            let h = `<table class="tableGS bg-white" id="tableGS" style="width:100%; table-layout:fixed; border-collapse:collapse;">
                <thead>
                    <tr class="bg-[#15803d] text-white">
                        <th style="width: 100px;">HORÁRIO</th>`;
            dias.forEach((d, i) => {
                const dt = new Date(start); dt.setDate(dt.getDate() + i);
                h += `<th style="width: 14%;">${d.toUpperCase()}<br><span class="text-[9px] opacity-80">${dt.toLocaleDateString('pt-BR').slice(0,5)}</span></th>`;
            });
            h += `</tr></thead><tbody>`;

            GABARITO.forEach(s => {
                if(s.t === "intervalo") {
                    h += `<tr class="intervalo-row"><td style="border:1px solid #ddd;">${s.h}</td><td colspan="6" style="border:1px solid #ddd;">${s.l}</td></tr>`;
                } else {
                    h += `<tr><td class="bg-gray-100 font-bold border text-[10px]">${s.h}</td>`;
                    for(let i=0; i<6; i++) {
                        const dtR = new Date(start); dtR.setDate(dtR.getDate()+i);
                        let cellContent = "";
                        for(let t in dataStore) {
                            for(let d in dataStore[t].discs) {
                                dataStore[t].discs[d].sch.forEach(x => {
                                    if(x.prof === prof && x.dtObj.getDate() === dtR.getDate() && x.dtObj.getMonth() === dtR.getMonth() && x.time.startsWith(s.h.split(' - ')[0])) {
                                        aulasPorDia[i]++;
                                        cellContent += `<div class="aula-card ${TRADUCAO[x.tag]?.class || 'status-normal'}">
                                            <div class="font-black uppercase" style="font-size:9px;">${dataStore[t].name}</div>
                                            <div class="border-t border-gray-200 mt-1" style="font-size:8px;">${dataStore[t].discs[d].name}</div>
                                        </div>`;
                                    }
                                });
                            }
                        }
                        h += `<td class="border" style="height:50px; vertical-align:top;">${cellContent}</td>`;
                    }
                    h += `</tr>`;
                }
            });

            for(let i=0; i<6; i++) {
                let aulasNoDia = [];
                const dtR = new Date(start); dtR.setDate(dtR.getDate()+i);
                for(let t in dataStore) {
                    for(let d in dataStore[t].discs) {
                        dataStore[t].discs[d].sch.forEach(x => {
                            if(x.prof === prof && x.dtObj.getDate() === dtR.getDate() && x.dtObj.getMonth() === dtR.getMonth()) {
                                const [hIni] = x.time.split(' - ')[0].split(':').map(Number);
                                const [hFim] = x.time.split(' - ')[1].split(':').map(Number);
                                aulasNoDia.push({ inicio: hIni, fim: hFim, data: new Date(dtR) });
                            }
                        });
                    }
                }
                if(aulasNoDia.length > 0) {
                    aulasNoDia.sort((a,b) => a.inicio - b.inicio);
                    let primeira = aulasNoDia[0], ultima = aulasNoDia[aulasNoDia.length-1];
                    let diff = ultima.fim - primeira.inicio;
                    if(primeira.inicio <= 12 && ultima.fim >= 14) diff -= 2;
                    horasPermanencia[i] = diff > 0 ? diff : 0;
                    if(ultimaAulaDiaAnterior) {
                        let dFimAnt = new Date(ultimaAulaDiaAnterior.data); dFimAnt.setHours(ultimaAulaDiaAnterior.fim, 0, 0);
                        let dIniAtu = new Date(primeira.data); dIniAtu.setHours(primeira.inicio, 0, 0);
                        let diffInter = (dIniAtu - dFimAnt) / (1000 * 60 * 60);
                        if(diffInter < 11) observacoes.push(`${dias[i]}: Intervalo de ${diffInter.toFixed(1)}h (mín. 11h)`);
                    }
                    ultimaAulaDiaAnterior = ultima;
                } else { ultimaAulaDiaAnterior = null; }
            }

            h += `<tr class="bg-gray-50 font-bold"><td class="text-[9px] border">AULAS DIÁRIAS</td>`;
            aulasPorDia.forEach(c => h += `<td class="border">${c}</td>`);
            h += `</tr><tr class="bg-blue-50 font-bold"><td class="text-[9px] border">PERMANÊNCIA</td>`;
            horasPermanencia.forEach(v => h += `<td class="border">${v}h</td>`);
            h += `</tr>`;

            const totalSemana = aulasPorDia.reduce((a,b) => a+b, 0);
            h += `<tr class="bg-green-50 font-black"><td colspan="2" class="text-left px-2 border">TOTAL SEMANAL:</td><td colspan="5" class="text-left px-2 border">${totalSemana} Aulas</td></tr>`;
            
            let obsTexto = observacoes.length > 0 ? observacoes.join(' | ') : "Interjornada regular.";
            h += `<tr class="text-[9px]"><td class="font-bold border bg-yellow-50">OBSERVAÇÕES:</td><td colspan="6" class="text-left px-2 border text-red-600 font-bold">${obsTexto}</td></tr>`;

            document.getElementById('gradeRender').innerHTML = h + "</tbody></table>";
        }

        function gerarGradeTurma() {
            const tId = document.getElementById('turmaSelectSemanal').value;
            const week = document.getElementById('weekInputTurma').value;
            if(!tId || !week) return alert("Selecione Turma e Semana");
            const [y, w] = week.split('-W').map(Number);
            const start = getStartOfWeek(w, y);
            const dias = ["Segunda", "Terça", "Quarta", "Quinta", "Sexta", "Sábado"];
            let h = `<table class="tableGS bg-white" id="tableGSTurma"><thead><tr class="bg-[#15803d] text-white"><th style="width: 80px;">HORÁRIO</th>`;
            dias.forEach((d, i) => {
                const dt = new Date(start); dt.setDate(dt.getDate() + i);
                h += `<th>${d.toUpperCase()}<br><span class="text-[9px] opacity-80">${dt.toLocaleDateString('pt-BR').slice(0,5)}</span></th>`;
            });
            h += `</tr></thead><tbody>`;
            GABARITO.forEach(s => {
                if(s.t === "intervalo") h += `<tr class="intervalo-row"><td>${s.h}</td><td colspan="6">${s.l}</td></tr>`;
                else {
                    h += `<tr><td class="bg-gray-100 font-bold border text-[10px]">${s.h}</td>`;
                    for(let i=0; i<6; i++) {
                        const dtR = new Date(start); dtR.setDate(dtR.getDate()+i);
                        let cellContent = "";
                        if(dataStore[tId]) {
                            for(let d in dataStore[tId].discs) {
                                dataStore[tId].discs[d].sch.forEach(x => {
                                    if(x.dtObj.getDate() === dtR.getDate() && x.dtObj.getMonth() === dtR.getMonth() && x.time.startsWith(s.h.split(' - ')[0])) {
                                        cellContent += `<div class="aula-card ${TRADUCAO[x.tag]?.class || 'status-normal'}">
                                            <div class="font-black uppercase" style="margin-bottom: 2px;">${dataStore[tId].discs[d].name}</div>
                                            <div class="border-t border-gray-200 pt-1 italic text-[8px]">${x.prof}</div>
                                        </div>`;
                                    }
                                });
                            }
                        }
                        h += `<td class="border">${cellContent}</td>`;
                    }
                    h += `</tr>`;
                }
            });
            document.getElementById('gradeTurmaRender').innerHTML = h + "</tbody></table>";
        }

        function getStartOfWeek(w, y) {
            const s = new Date(y, 0, 1 + (w - 1) * 7);
            const d = s.getDay();
            if (d <= 4) s.setDate(s.getDate() - s.getDay() + 1); else s.setDate(s.getDate() + 8 - s.getDay());
            return s;
        }

        function gerarCabecalhoPadrao(doc) {
            doc.setFont("helvetica", "bold"); doc.setFontSize(14);
            doc.text("INSTITUTO FEDERAL DE RONDÔNIA - IFRO", 105, 15, { align: "center" });
            doc.setFontSize(12); doc.text("CAMPUS CACOAL", 105, 22, { align: "center" });
            doc.setFontSize(10); doc.setFont("helvetica", "normal");
            doc.text("DEPARTAMENTO DE APOIO AO ENSINO", 105, 30, { align: "center" });
            doc.text("COORDENAÇÃO DE DESENVOLVIMENTO DE FERRAMENTAS PEDAGÓGICAS", 105, 35, { align: "center" });
            doc.setDrawColor(21, 128, 61); doc.setLineWidth(0.5); doc.line(14, 38, 196, 38);
        }

        function gerarRodapePadrao(doc) {
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i); doc.setFontSize(8); doc.setTextColor(100); doc.line(14, 285, 196, 285);
                doc.text("BR-364, Km 228, Lote 2-A, Zona Rural, Cacoal - RO | Tel: (69) 3443-9501", 105, 289, { align: "center" });
                doc.text("E-mail: dape.cacoal@ifro.edu.br | Página " + i + " de " + pageCount, 105, 293, { align: "center" });
            }
        }

        function exportarDisciplinaPDF() {
            const { jsPDF } = window.jspdf; const doc = new jsPDF('p', 'mm', 'a4');
            const tId = document.getElementById('turmaSelect').value;
            const dId = document.getElementById('disciplinaSelect').value;
            const sem = document.getElementById('semestreSelect').value;
            const data = dataStore[tId].discs[dId];
            const turmaNome = dataStore[tId].name;
            const dataEmissao = new Date().toLocaleDateString('pt-BR').replace(/\//g, '-');

            const aulasFiltradas = data.sch.filter(a => {
                const m = a.dtObj.getMonth() + 1;
                return ehSemestral(tId) ? (sem === "1" ? m <= 6 : m > 6) : true;
            });
            
            const profs = [...new Set(aulasFiltradas.map(s => s.prof))].join(", ");
            const somaAulas = aulasFiltradas.filter(s => !s.tag || TRADUCAO[s.tag].soma).length;
            
            gerarCabecalhoPadrao(doc);
            doc.setFont("helvetica", "bold"); doc.setFontSize(11);
            doc.text(`DISCIPLINA: ${data.name} ${ehSemestral(tId) ? '('+sem+'º SEMESTRE)' : ''}`, 14, 45);
            doc.text(`PROFESSORES: ${profs}`, 14, 51);
            doc.text(`TOTAL DE AULAS (EXCETO REC/EX): ${somaAulas}`, 14, 57);
            html2canvas(document.querySelector("#tableD")).then(canvas => {
    const imgData = canvas.toDataURL("image/png");
    const imgWidth = 190;
    const pageHeight = 277;
    const imgHeight = canvas.height * imgWidth / canvas.width;
    let heightLeft = imgHeight;

    let position = 62;

    doc.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
    heightLeft -= pageHeight;

    while (heightLeft > 0) {
        position = heightLeft - imgHeight + 62;
        doc.addPage();
        doc.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;
    }

    gerarRodapePadrao(doc);
    doc.save(`${data.name} - ${turmaNome} - ${dataEmissao}.pdf`);
});


        function exportarPivoPDF() {
            const { jsPDF } = window.jspdf; const doc = new jsPDF('p', 'mm', 'a4');
            const tId = document.getElementById('turmaSelectPivo').value;
            const sem = document.getElementById('semestreSelectPivo').value;
            const turmaNome = dataStore[tId].name;
            const dataEmissao = new Date().toLocaleDateString('pt-BR').replace(/\//g, '-');

            gerarCabecalhoPadrao(doc);
            doc.setFont("helvetica", "bold"); doc.setFontSize(12);
            doc.text(`RELATÓRIO ANUAL DA TURMA: ${turmaNome} ${ehSemestral(tId) ? '('+sem+'º SEMESTRE)' : ''}`, 14, 45);
            html2canvas(document.querySelector("#tablePivo")).then(canvas => {
    const imgData = canvas.toDataURL("image/png");
    const imgWidth = 190;
    const imgHeight = canvas.height * imgWidth / canvas.width;

    doc.addImage(imgData, 'PNG', 10, 50, imgWidth, imgHeight);

    gerarRodapePadrao(doc);
    doc.save(`${turmaNome} - ${dataEmissao}.pdf`);
});


        function exportarGradePDF() {
            const { jsPDF } = window.jspdf; const doc = new jsPDF('p', 'mm', 'a4');
            const prof = document.getElementById('profSelect').value;
            const week = document.getElementById('weekInput').value;
            const dataEmissao = new Date().toLocaleDateString('pt-BR').replace(/\//g, '-');
            if(!prof || !week) return alert("Selecione Professor e Semana");
            
            const [y, w] = week.split('-W').map(Number);
            const start = getStartOfWeek(w, y);
            const end = new Date(start); end.setDate(end.getDate() + 5);
            
            gerarCabecalhoPadrao(doc);
            doc.setFont("helvetica", "bold"); doc.setFontSize(11);
            doc.text(`PROFESSOR(A): ${prof}`, 14, 45);
            doc.text(`Semana: ${start.toLocaleDateString('pt-BR')} a ${end.toLocaleDateString('pt-BR')} - Semana ${w}`, 14, 51);
            
            html2canvas(document.querySelector("#tableGS")).then(canvas => {
    const imgData = canvas.toDataURL("image/png");
    const imgWidth = 190;
    const imgHeight = canvas.height * imgWidth / canvas.width;

    doc.addImage(imgData, 'PNG', 10, 56, imgWidth, imgHeight);

    gerarRodapePadrao(doc);
    doc.save(`Ficha Semanal - ${prof} - ${dataEmissao}.pdf`);
});


        function exportarGradeTurmaPDF() {
            const { jsPDF } = window.jspdf; const doc = new jsPDF('p', 'mm', 'a4');
            const tId = document.getElementById('turmaSelectSemanal').value;
            const week = document.getElementById('weekInputTurma').value;
            const dataEmissao = new Date().toLocaleDateString('pt-BR').replace(/\//g, '-');
            if(!tId || !week) return alert("Selecione Turma e Semana");
            
            const turmaNome = dataStore[tId].name;
            const [y, w] = week.split('-W').map(Number);
            const start = getStartOfWeek(w, y);
            const end = new Date(start); end.setDate(end.getDate() + 5);
            
            gerarCabecalhoPadrao(doc);
            doc.setFont("helvetica", "bold"); doc.setFontSize(11);
            doc.text(`TURMA: ${turmaNome}`, 14, 45);
            doc.text(`Semana: ${start.toLocaleDateString('pt-BR')} a ${end.toLocaleDateString('pt-BR')} - Semana ${w}`, 14, 51);
            
            html2canvas(document.querySelector("#tableGSTurma")).then(canvas => {
    const imgData = canvas.toDataURL("image/png");
    const imgWidth = 190;
    const imgHeight = canvas.height * imgWidth / canvas.width;

    doc.addImage(imgData, 'PNG', 10, 56, imgWidth, imgHeight);

    gerarRodapePadrao(doc);
    doc.save(`Ficha Semanal - ${turmaNome} - ${dataEmissao}.pdf`);
});


        function initTabs() {
            document.querySelectorAll('.tab-btn').forEach(b => {
                b.onclick = () => {
                    document.querySelectorAll('.tab-btn, .tab-pane').forEach(e => e.classList.remove('active'));
                    b.classList.add('active'); document.getElementById(b.dataset.tab).classList.add('active');
                };
            });
        }
    </script>
</body>
</html>
