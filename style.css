<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SGP - IFRO Cacoal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .tab-btn.active { border-bottom: 4px solid #15803d; color: #15803d; font-weight: 800; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }
        .aula-card { padding: 4px; margin-bottom: 4px; border-radius: 4px; line-height: 1.1; border-left: 4px solid #15803d; font-size: 9px; text-align: center; }
        .status-normal { background-color: #f0fdf4; border-color: #15803d; }
        .status-extra { background-color: #ecfdf5; border-color: #059669; color: #065f46; } /* [+] */
        .status-reposicao { background-color: #eff6ff; border-color: #2563eb; color: #1e40af; } /* [R] */
        .status-rec { background-color: #fdf2f8; border-color: #db2777; color: #9d174d; } /* [REC] */
        .status-exame { background-color: #f5f5f5; border-color: #4b5563; color: #1f2937; } /* [EX] */
        .intervalo-row { background-color: #f3f4f6; color: #9ca3af; font-weight: bold; font-size: 10px; text-transform: uppercase; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <header class="bg-[#15803d] text-white p-6 shadow-lg">
        <div class="container mx-auto flex flex-col md:flex-row justify-between items-center">
            <div>
                <h1 class="text-2xl font-black italic uppercase tracking-tighter">IFRO - CAMPUS CACOAL</h1>
                <p class="text-xs font-bold opacity-80 uppercase">Sistema de Gestão Pedagógica</p>
            </div>
            <div class="flex items-center gap-4 mt-4 md:mt-0">
                <select id="yearSelect" class="bg-white/20 border border-white/30 p-2 rounded text-white font-bold outline-none">
                    <option value="2025" class="text-black">ANO 2025</option>
                    <option value="2026" class="text-black">ANO 2026</option>
                </select>
                <div id="dataRelatorio" class="bg-white/10 px-4 py-2 rounded-lg font-mono text-sm border border-white/20">--/--/----</div>
            </div>
        </div>
    </header>

    <nav class="bg-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto flex overflow-x-auto">
            <button class="tab-btn px-6 py-4 active" data-tab="tab-disciplina">POR DISCIPLINA</button>
            <button class="tab-btn px-6 py-4" data-tab="tab-turma">POR TURMA (PIVÔ)</button>
            <button class="tab-btn px-6 py-4" data-tab="tab-semanal">GRADE SEMANAL</button>
        </div>
    </nav>

    <main class="container mx-auto p-4 md:p-6">
        <section id="tab-disciplina" class="tab-pane active">
            <div class="bg-white p-6 rounded-xl shadow-sm border">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <select id="turmaSelect" class="p-3 border rounded-lg font-bold bg-gray-50"></select>
                    <select id="disciplinaSelect" class="p-3 border rounded-lg bg-gray-50" disabled><option>Selecione a Turma</option></select>
                    <select id="semestreFiltro" class="p-3 border rounded-lg bg-blue-50 font-bold text-blue-800">
                        <option value="1">1º SEMESTRE</option>
                        <option value="2">2º SEMESTRE</option>
                    </select>
                </div>
                <div id="resultadoBusca" class="hidden">
                    <div class="flex flex-wrap gap-4 mb-4">
                        <div class="bg-green-100 p-4 rounded-lg border border-green-200 text-center"><p class="text-[10px] font-bold">AULAS REGULARES</p><span id="cont-regular" class="text-2xl font-black">0</span></div>
                        <div class="bg-pink-100 p-4 rounded-lg border border-pink-200 text-center"><p class="text-[10px] font-bold">RECUPERAÇÃO/EXAME</p><span id="cont-extra" class="text-2xl font-black">0</span></div>
                        <button onclick="exportarDisciplinaPDF()" class="bg-gray-800 text-white px-6 rounded-lg font-bold ml-auto hover:bg-black transition">EXPORTAR PDF</button>
                    </div>
                    <table id="tableD" class="min-w-full bg-white border text-center text-xs">
                        <thead class="bg-gray-50 uppercase text-[9px] font-black">
                            <tr><th class="p-3 border">DATA</th><th class="p-3 border">DIA</th><th class="p-3 border">HORÁRIO</th><th class="p-3 border">PROFESSOR</th><th class="p-3 border">STATUS</th></tr>
                        </thead>
                        <tbody id="bodyD"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="tab-turma" class="tab-pane">
            <div class="bg-white p-6 rounded-xl shadow-sm border">
                <div class="flex flex-col md:flex-row gap-4 mb-6">
                    <select id="turmaSelectPivo" class="p-3 border rounded-lg font-bold w-full md:w-64 bg-gray-50"></select>
                    <button onclick="exportarPivoPDF()" class="bg-green-700 text-white px-8 py-3 rounded-lg font-bold">EXPORTAR PIVÔ PDF</button>
                </div>
                <div class="overflow-x-auto">
                    <table id="tablePivo" class="min-w-full border text-[10px] text-center">
                        <thead class="bg-[#15803d] text-white">
                            <tr>
                                <th class="p-2 text-left">DISCIPLINA</th>
                                <th>JAN</th><th>FEV</th><th>MAR</th><th>ABR</th><th>MAI</th><th>JUN</th><th>JUL</th><th>AGO</th><th>SET</th><th>OUT</th><th>NOV</th><th>DEZ</th>
                                <th class="bg-green-600">TOTAL</th>
                            </tr>
                        </thead>
                        <tbody id="bodyPivo" class="bg-white"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="tab-semanal" class="tab-pane">
            <div class="bg-white p-6 rounded-xl shadow-sm border">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <select id="profSelect" class="p-3 border rounded-lg font-bold bg-gray-50"></select>
                    <input type="week" id="weekInput" class="p-3 border rounded-lg">
                    <div class="flex gap-2">
                        <button onclick="gerarGrade()" class="bg-blue-600 text-white font-bold rounded-lg flex-1">VISUALIZAR</button>
                        <button onclick="exportarGradePDF()" class="bg-green-700 text-white font-bold rounded-lg flex-1">PDF GRADE</button>
                    </div>
                </div>
                <div id="gradeRender"></div>
            </div>
        </section>
    </main>

    <script>
        const TRADUCAO = { 
            "+": { texto: "EXTRA", class: "status-extra", soma: true },
            "R": { texto: "REPOSIÇÃO", class: "status-reposicao", soma: true },
            "REC": { texto: "RECUPERAÇÃO", class: "status-rec", soma: false },
            "EX": { texto: "EXAME", class: "status-exame", soma: false }
        };

        const GABARITO = [
            {h:"07:30 - 08:20", t:"aula"}, {h:"08:20 - 09:10", t:"aula"}, 
            {h:"09:10 - 09:30", t:"intervalo", l:"INTERVALO"},
            {h:"09:30 - 10:20", t:"aula"}, {h:"10:20 - 11:10", t:"aula"}, {h:"11:10 - 12:00", t:"aula"},
            {h:"12:00 - 13:30", t:"intervalo", l:"ALMOÇO"},
            {h:"13:30 - 14:20", t:"aula"}, {h:"14:20 - 15:10", t:"aula"},
            {h:"15:10 - 15:30", t:"intervalo", l:"INTERVALO"},
            {h:"15:30 - 16:20", t:"aula"}, {h:"16:20 - 17:10", t:"aula"}, {h:"17:10 - 18:00", t:"aula"},
            {h:"18:00 - 19:00", t:"intervalo", l:"JANTAR"},
            {h:"19:00 - 19:50", t:"aula"}, {h:"19:50 - 20:40", t:"aula"},
            {h:"20:40 - 20:50", t:"intervalo", l:"INTERVALO"},
            {h:"20:50 - 21:40", t:"aula"}, {h:"21:40 - 22:30", t:"aula"}
        ];

        let dataStore = {};
        const GIST_URL = "https://gist.githubusercontent.com/jamilsalim-afk/15207392062fe2b7f6fbd0a788e8d99c/raw/292ce2bacff996ab2e8f5fe0b4608488048b8616/DADOS_2026_MESTRE";

        window.onload = () => {
            document.getElementById('dataRelatorio').textContent = new Date().toLocaleDateString('pt-BR');
            carregarDados();
            initTabs();
        };

        async function carregarDados() {
            try {
                const res = await fetch(GIST_URL);
                const csv = await res.text();
                const lines = csv.split(/\r?\n/).filter(l => l.trim().length > 0);
                
                // Pegamos a primeira linha de cabeçalho
                const headers = lines[0].split(';').map(h => h.trim());
                const turmas = headers.slice(2);
                
                dataStore = {};
                let lastDate = "";

                lines.slice(1).forEach(line => {
                    const cols = line.split(';').map(c => c?.trim());
                    // Se a linha começa com data, atualizamos a data atual
                    if (cols[0] && cols[0].includes('.')) lastDate = cols[0].replace(/\./g, '/');
                    
                    const horario = cols[1];
                    if (!horario) return;

                    turmas.forEach((tNome, idx) => {
                        const cell = cols[idx + 2];
                        if (!cell || cell === "" || cell === "PPS/Atendimento") return;

                        const tId = tNome.toLowerCase().replace(/[^a-z0-9]/g, '');
                        if (!dataStore[tId]) dataStore[tId] = { name: tNome, discs: {} };

                        // Lógica Robusta de Extração: "Disciplina - Professor [TAG]"
                        const tagM = cell.match(/\[(.*?)\]/);
                        const tag = tagM ? tagM[1].toUpperCase() : null;
                        const cleanT = tagM ? cell.replace(tagM[0], "").trim() : cell;
                        
                        // Divide pelo último hífen para evitar problemas com nomes de disciplinas que levam hífen
                        let disc, prof;
                        if (cleanT.includes(' - ')) {
                            const partes = cleanT.split(' - ');
                            prof = partes.pop().trim();
                            disc = partes.join(' - ').trim();
                        } else {
                            disc = cleanT;
                            prof = "N/I";
                        }

                        const dId = disc.toLowerCase().replace(/[^a-z0-9]/g, '');
                        if (!dataStore[tId].discs[dId]) dataStore[tId].discs[dId] = { name: disc, sch: [] };

                        const [d, m, a] = lastDate.split('/');
                        const dt = new Date(a, m-1, d);

                        dataStore[tId].discs[dId].sch.push({
                            date: lastDate, dtObj: dt, wd: dt.toLocaleDateString('pt-BR',{weekday:'long'}),
                            time: horario, prof: prof, tag: tag
                        });
                    });
                });
                popularSelects();
            } catch (e) { alert("Erro ao ler dados. Verifique o link do Gist."); }
        }

        function popularSelects() {
            const t1 = document.getElementById('turmaSelect');
            const t2 = document.getElementById('turmaSelectPivo');
            const ps = document.getElementById('profSelect');
            const profs = new Set();

            [t1, t2].forEach(s => {
                const prev = s.value;
                s.innerHTML = '<option value="">-- SELECIONE A TURMA --</option>';
                Object.keys(dataStore).sort().forEach(id => s.innerHTML += `<option value="${id}">${dataStore[id].name}</option>`);
                s.value = prev;
            });

            for(let t in dataStore) for(let d in dataStore[t].discs) dataStore[t].discs[d].sch.forEach(x => profs.add(x.prof));
            ps.innerHTML = '<option value="">-- PROFESSOR --</option>';
            Array.from(profs).sort().forEach(p => ps.innerHTML += `<option value="${p}">${p}</option>`);
        }

        // RELATÓRIO POR DISCIPLINA
        document.getElementById('turmaSelect').onchange = (e) => {
            const dS = document.getElementById('disciplinaSelect');
            const tId = e.target.value;
            dS.innerHTML = '<option value="">-- DISCIPLINA --</option>';
            if(dataStore[tId]) {
                Object.keys(dataStore[tId].discs).sort().forEach(id => dS.innerHTML += `<option value="${id}">${dataStore[tId].discs[id].name}</option>`);
                dS.disabled = false;
            }
        };

        document.getElementById('disciplinaSelect').onchange = renderD;
        function renderD() {
            const tId = document.getElementById('turmaSelect').value;
            const dId = document.getElementById('disciplinaSelect').value;
            const b = document.getElementById('bodyD');
            if(!tId || !dId) return;
            b.innerHTML = '';
            let sR = 0, sE = 0;
            dataStore[tId].discs[dId].sch.forEach(a => {
                const info = TRADUCAO[a.tag] || {texto:"NORMAL", class:"", soma:true};
                if(info.soma) sR++; else sE++;
                b.innerHTML += `<tr class="${info.class}"><td class="p-2 border">${a.date}</td><td class="p-2 border uppercase text-[8px]">${a.wd}</td><td class="p-2 border">${a.time}</td><td class="p-2 border font-bold">${a.prof}</td><td class="p-2 border font-black">${info.texto}</td></tr>`;
            });
            document.getElementById('cont-regular').textContent = sR;
            document.getElementById('cont-extra').textContent = sE;
            document.getElementById('resultadoBusca').classList.remove('hidden');
        }

        // ABA PIVÔ
        document.getElementById('turmaSelectPivo').onchange = renderPivo;
        function renderPivo() {
            const tId = document.getElementById('turmaSelectPivo').value;
            const b = document.getElementById('bodyPivo');
            if(!tId) return;
            b.innerHTML = '';
            for(let dId in dataStore[tId].discs) {
                let mCount = Array(12).fill(0);
                dataStore[tId].discs[dId].sch.forEach(s => mCount[s.dtObj.getMonth()]++);
                let row = `<tr class="border-b hover:bg-gray-50"><td class="p-2 text-left font-bold border-r bg-gray-50">${dataStore[tId].discs[dId].name}</td>`;
                mCount.forEach(c => row += `<td class="border-r">${c||'-'}</td>`);
                row += `<td class="bg-green-50 font-black">${mCount.reduce((a,b)=>a+b)}</td></tr>`;
                b.innerHTML += row;
            }
        }

        // GRADE SEMANAL
        function gerarGrade() {
            const prof = document.getElementById('profSelect').value;
            const week = document.getElementById('weekInput').value;
            if(!prof || !week) return alert("Selecione Professor e Semana");
            const [y, w] = week.split('-W').map(Number);
            const start = getStartOfWeek(w, y);
            const dias = ["Segunda-feira", "Terça-feira", "Quarta-feira", "Quinta-feira", "Sexta-feira", "Sábado"];
            
            let html = `<table id="tableGS" class="min-w-full border bg-white text-center text-[9px]"><thead><tr class="bg-[#15803d] text-white"><th class="p-2 border">HORÁRIO</th>`;
            dias.forEach((d, i) => {
                const dt = new Date(start); dt.setDate(dt.getDate() + i);
                html += `<th class="p-2 border">${d.toUpperCase()}<br>${dt.toLocaleDateString('pt-BR')}</th>`;
            });
            html += `</tr></thead><tbody>`;

            GABARITO.forEach(s => {
                if(s.t === "intervalo") {
                    html += `<tr class="intervalo-row"><td class="p-1 border">${s.h}</td><td colspan="6" class="p-1 border">${s.l}</td></tr>`;
                } else {
                    html += `<tr><td class="bg-gray-50 font-bold p-2 border">${s.h}</td>`;
                    dias.forEach((dNome, i) => {
                        const dtR = new Date(start); dtR.setDate(dtR.getDate()+i);
                        let cell = "";
                        for(let t in dataStore) for(let d in dataStore[t].discs) dataStore[t].discs[d].sch.forEach(x => {
                            if(x.prof === prof && x.dtObj.getDate() === dtR.getDate() && x.dtObj.getMonth() === dtR.getMonth() && x.time.includes(s.h.split('-')[0].trim())) {
                                const st = TRADUCAO[x.tag] || {class:"status-normal"};
                                cell += `<div class="aula-card ${st.class}"><b>${dataStore[t].name}</b><br>${dataStore[t].discs[d].name}</div>`;
                            }
                        });
                        html += `<td class="p-1 border align-middle">${cell}</td>`;
                    });
                    html += `</tr>`;
                }
            });
            document.getElementById('gradeRender').innerHTML = html + "</tbody></table>";
        }

        // EXPORTAÇÃO PDF COM REPARO
        function exportarDisciplinaPDF() {
            const { jsPDF } = window.jspdf; 
            const doc = new jsPDF();
            doc.setFontSize(14); doc.text("IFRO - RELATÓRIO POR DISCIPLINA", 14, 15);
            doc.autoTable({ html: '#tableD', startY: 25, theme: 'grid', styles: { fontSize: 8 } });
            doc.save("Relatorio_Disciplina.pdf");
        }

        function exportarPivoPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l');
            doc.text("IFRO - MAPA ANUAL POR TURMA", 14, 15);
            doc.autoTable({ html: '#tablePivo', startY: 25, theme: 'grid', styles: { fontSize: 7 } });
            doc.save("Mapa_Anual_Turma.pdf");
        }

        function exportarGradePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l');
            doc.text("IFRO - GRADE SEMANAL DO PROFESSOR", 14, 15);
            doc.autoTable({ html: '#tableGS', startY: 25, theme: 'grid', styles: { fontSize: 6 } });
            doc.save("Grade_Semanal.pdf");
        }

        function getStartOfWeek(w, y) {
            const s = new Date(y, 0, 1 + (w - 1) * 7);
            const d = s.getDay();
            if (d <= 4) s.setDate(s.getDate() - s.getDay() + 1);
            else s.setDate(s.getDate() + 8 - s.getDay());
            return s;
        }

        function initTabs() {
            document.querySelectorAll('.tab-btn').forEach(b => {
                b.onclick = () => {
                    document.querySelectorAll('.tab-btn, .tab-pane').forEach(e => e.classList.remove('active'));
                    b.classList.add('active');
                    document.getElementById(b.dataset.tab).classList.add('active');
                };
            });
        }
    </script>
</body>
</html>
